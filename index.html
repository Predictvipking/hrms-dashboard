<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise HRMS Pro</title>
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { --primary: #1e3a8a; --accent: #2563eb; --bg: #f1f5f9; --text: #334155; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; color: var(--text); }
        .hidden { display: none !important; }
        
        /* Components */
        .btn { padding: 10px 18px; border: none; border-radius: 6px; cursor: pointer; background: var(--accent); color: white; font-weight: 600; font-size: 0.9rem; }
        .btn:hover { background: #1d4ed8; } .btn-danger { background: #dc2626; } 
        .card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        
        /* Layout Grid */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        
        /* Inputs with Labels */
        .input-group { display: flex; flex-direction: column; }
        .input-group label { font-size: 0.8rem; font-weight: 600; margin-bottom: 4px; color: #64748b; }
        input, select { padding: 9px; border: 1px solid #cbd5e1; border-radius: 5px; font-size: 0.95rem; }
        input:focus { outline: 2px solid var(--accent); border-color: transparent; }
        
        /* Sidebar & Layout */
        .dashboard { display: flex; height: 100vh; }
        .sidebar { width: 250px; background: #0f172a; color: white; display: flex; flex-direction: column; }
        .brand { padding: 20px; font-size: 1.4rem; font-weight: bold; border-bottom: 1px solid #334155; text-align: center; }
        .nav-item { padding: 15px 20px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05); transition: 0.2s; }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.1); border-left: 4px solid var(--accent); }
        
        .content { flex: 1; padding: 20px; overflow-y: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        /* Loader */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction: column; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; border-radius: 8px; overflow: hidden; }
        th { background: #e2e8f0; padding: 12px; text-align: left; font-weight: 600; }
        td { padding: 10px 12px; border-bottom: 1px solid #f1f5f9; }
        
        /* Section Header */
        .sec-head { font-size: 1rem; font-weight: bold; color: var(--primary); border-bottom: 2px solid #e2e8f0; padding-bottom: 5px; margin: 15px 0 10px 0; }
    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div><p style="margin-top:10px">Connecting...</p></div>

    <!-- 1. SETUP -->
    <div id="view-setup" class="hidden" style="display:flex; justify-content:center; align-items:center; height:100vh;">
        <div class="card" style="width:400px; text-align:center;">
            <h2 style="color:var(--primary)">System Setup</h2>
            <form id="setupForm">
                <div class="input-group"><label>Organization Name</label><input id="setupOrg" required></div>
                <div class="input-group"><label>Address</label><input id="setupAddr" required></div>
                <div class="input-group"><label>Admin Email</label><input type="email" id="setupEmail" required></div>
                <div class="input-group"><label>Password</label><input type="password" id="setupPass" required></div>
                <button class="btn" style="width:100%; margin-top:15px">Initialize</button>
            </form>
        </div>
    </div>

    <!-- 2. LOGIN -->
    <div id="view-login" class="hidden" style="display:flex; justify-content:center; align-items:center; height:100vh;">
        <div class="card" style="width:350px; text-align:center;">
            <h2 id="loginOrgName">Login</h2>
            <form id="loginForm">
                <div class="input-group"><label>Email</label><input type="email" id="loginEmail" required></div>
                <div class="input-group"><label>Password</label><input type="password" id="loginPass" required></div>
                <button class="btn" style="width:100%; margin-top:15px">Login</button>
            </form>
        </div>
    </div>

    <!-- 3. DASHBOARD -->
    <div id="view-dashboard" class="dashboard hidden">
        <div class="sidebar">
            <div class="brand">HRMS Pro</div>
            <div class="nav-item active" id="nav-home" onclick="navTo('tab-home')">üìä Dashboard</div>
            <div class="nav-item" id="nav-users" onclick="navTo('tab-users')">üîê Admin Console</div>
            <div class="nav-item" id="nav-depts" onclick="navTo('tab-depts')">üè¢ Departments</div>
            <div class="nav-item" id="nav-emp" onclick="navTo('tab-emp')">üë• Employees</div>
            <div class="nav-item" id="nav-pay" onclick="navTo('tab-pay')">üßæ Payslip Generator</div>
            <div style="flex:1"></div>
            <div class="nav-item" onclick="location.reload()" style="background:#dc2626;">üö™ Logout</div>
        </div>

        <div class="content">
            <div class="header">
                <h2 id="pageTitle">Dashboard</h2>
                <div style="text-align:right">
                    <span id="userDisplay" style="font-weight:bold; color:var(--primary)">User</span><br>
                    <span id="roleDisplay" style="font-size:0.8rem; background:#cbd5e1; padding:2px 6px; border-radius:4px;">Role</span>
                </div>
            </div>

            <!-- HOME -->
            <div id="tab-home">
                <div class="grid-3">
                    <div class="card"><h3>Staff Count</h3><h1 id="statEmp" style="color:var(--accent)">0</h1></div>
                    <div class="card"><h3>Departments</h3><h1 id="statDept">0</h1></div>
                </div>
            </div>

            <!-- ADMIN CONSOLE -->
            <div id="tab-users" class="hidden">
                <div class="grid-2">
                    <div class="card">
                        <h3>Create User</h3>
                        <form id="userForm">
                            <div class="input-group"><label>Name</label><input id="newUserName" required></div>
                            <div class="input-group"><label>Email</label><input type="email" id="newUserEmail" required></div>
                            <div class="input-group"><label>Password</label><input type="password" id="newUserPass" required></div>
                            <div class="input-group"><label>Role</label>
                                <select id="newUserRole">
                                    <option value="HR">HR</option>
                                    <option value="MANAGER">Manager</option>
                                    <option value="ACCOUNTANT">Accountant</option>
                                </select>
                            </div>
                            <p><b>Permissions:</b></p>
                            <div class="grid-2">
                                <label><input type="checkbox" id="perm_dept"> Manage Dept</label>
                                <label><input type="checkbox" id="perm_emp"> Manage Staff</label>
                                <label><input type="checkbox" id="perm_pay"> Generate Payslip</label>
                            </div>
                            <button class="btn" style="width:100%; margin-top:10px">Add User</button>
                        </form>
                    </div>
                    <div class="card">
                        <h3>Users List</h3>
                        <table id="userTable"><thead><tr><th>Name</th><th>Role</th><th>Action</th></tr></thead><tbody id="userTableBody"></tbody></table>
                    </div>
                </div>
            </div>

            <!-- DEPARTMENTS -->
            <div id="tab-depts" class="hidden">
                <div class="grid-2">
                    <div class="card">
                        <form id="deptForm">
                            <div class="input-group"><label>Entity (e.g. NIDS)</label><input id="newEntity" required></div>
                            <div class="input-group"><label>Dept Name</label><input id="newDept" required></div>
                            <button class="btn" style="margin-top:10px">Add</button>
                        </form>
                    </div>
                    <div class="card">
                        <table id="deptTable"><thead><tr><th>Entity</th><th>Dept</th><th>Act</th></tr></thead><tbody id="deptTableBody"></tbody></table>
                    </div>
                </div>
            </div>

            <!-- EMPLOYEES -->
            <div id="tab-emp" class="hidden">
                <button class="btn" onclick="toggleModal('modal-emp')">+ Add Employee</button>
                <div class="card" style="margin-top:15px">
                    <table id="empTable"><thead><tr><th>Code</th><th>Name</th><th>Entity/Dept</th><th>Action</th></tr></thead><tbody id="empTableBody"></tbody></table>
                </div>
            </div>

            <!-- PAYSLIP GENERATOR -->
            <div id="tab-pay" class="hidden">
                <div class="card" style="max-width:900px; margin:0 auto;">
                    <div class="sec-head">1. Select Employee</div>
                    <div class="grid-2">
                        <div class="input-group">
                            <label>Employee</label>
                            <select id="psEmpSelect" onchange="autoFetchEmp()"><option>-- Select --</option></select>
                        </div>
                        <div class="input-group"><label>Selected:</label><input id="psDisplayInfo" readonly style="background:#f1f5f9; font-weight:bold"></div>
                    </div>

                    <div class="sec-head">2. Period</div>
                    <div class="grid-3">
                        <div class="input-group"><label>Month</label><select id="psMonth"><option>January</option><option>February</option><option>March</option><option>April</option><option>May</option><option>June</option><option>July</option><option>August</option><option>September</option><option>October</option><option>November</option><option>December</option></select></div>
                        <div class="input-group"><label>Year</label><select id="psYear"></select></div>
                        <div class="input-group"><label>Total Days</label><input type="number" id="psTotalDays" value="30"></div>
                    </div>

                    <div class="sec-head">3. Attendance & Leaves (For Payslip)</div>
                    <div class="grid-4">
                        <div class="input-group"><label>Casual Leave (CL)</label><input type="number" id="psCL" value="0"></div>
                        <div class="input-group"><label>Sick Leave (SL)</label><input type="number" id="psSL" value="0"></div>
                        <div class="input-group"><label>Annual Leave (AL)</label><input type="number" id="psAL" value="0"></div>
                        <div class="input-group"><label>Absent Days</label><input type="number" id="psAbsent" value="0"></div>
                        <div class="input-group"><label>Present Days</label><input type="number" id="psPresent" value="30"></div>
                        <div class="input-group"><label>Pay Days</label><input type="number" id="psPayDays" value="30"></div>
                    </div>

                    <div class="sec-head">4. Variable Deductions (Monthly)</div>
                    <div class="grid-4">
                        <div class="input-group"><label>Food</label><input type="number" id="psDedFood" value="0"></div>
                        <div class="input-group"><label>MUT</label><input type="number" id="psDedMUT" value="0"></div>
                        <div class="input-group"><label>Income Tax</label><input type="number" id="psDedTax" value="0"></div>
                        <div class="input-group"><label>Retiree Welfare</label><input type="number" id="psDedWelfare" value="0"></div>
                        <div class="input-group"><label>Medical Exp</label><input type="number" id="psDedMed" value="0"></div>
                        <div class="input-group"><label>Adv/Loan/TDS</label><input type="number" id="psDedAdv" value="0"></div>
                        <div class="input-group"><label>Loss Of Pay</label><input type="number" id="psDedLOP" value="0"></div>
                    </div>
                    
                    <!-- Hidden Fixed Salary (Fetched from Profile) -->
                    <input type="hidden" id="fixBasic"><input type="hidden" id="fixDA">
                    <input type="hidden" id="fixTA"><input type="hidden" id="fixHRA">
                    <input type="hidden" id="fixOther"><input type="hidden" id="fixEPF">
                    <input type="hidden" id="fixESI">

                    <button class="btn" style="width:100%; margin-top:25px; padding:12px; font-size:1.1rem" onclick="generatePDF()">Generate Payslip (PDF)</button>
                </div>
            </div>

        </div>
    </div>

    <!-- MODAL: ADD EMPLOYEE (Fixed UI) -->
    <div id="modal-emp" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center; z-index:9999;">
        <div class="card" style="width:800px; max-height:95vh; overflow-y:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #e2e8f0; padding-bottom:10px;">
                <h3>Add Employee</h3>
                <button onclick="toggleModal('modal-emp')" style="background:none; border:none; font-size:1.5rem; cursor:pointer">&times;</button>
            </div>
            <form id="empForm">
                <div class="sec-head">Personal Details</div>
                <div class="grid-2">
                    <div class="input-group"><label>Full Name</label><input id="empName" required></div>
                    <div class="input-group"><label>Department</label><select id="empDeptSelect" required></select></div>
                    <div class="input-group"><label>Designation</label><input id="empDesg" required></div>
                    <div class="input-group"><label>Date of Joining</label><input type="date" id="empDOJ" required></div>
                    <div class="input-group"><label>Aadhaar No</label><input id="empAadhaar"></div>
                    <div class="input-group"><label>PAN No</label><input id="empPAN"></div>
                </div>

                <div class="sec-head">Bank & Statutory</div>
                <div class="grid-2">
                    <div class="input-group"><label>Bank Name</label><input id="empBank"></div>
                    <div class="input-group"><label>Account No</label><input id="empAC"></div>
                    <div class="input-group"><label>IFSC Code</label><input id="empIFSC"></div>
                    <div class="input-group"><label>ESI Number</label><input id="empESI"></div>
                    <div class="input-group"><label>UAN Number</label><input id="empUAN"></div>
                </div>

                <div class="sec-head">Salary Structure (Monthly Fixed)</div>
                <!-- FIXED UI: LABELED INPUTS -->
                <div class="grid-4">
                    <div class="input-group"><label>Basic (‚Çπ)</label><input type="number" id="salBasic" value="0"></div>
                    <div class="input-group"><label>DA (‚Çπ)</label><input type="number" id="salDA" value="0"></div>
                    <div class="input-group"><label>TA (‚Çπ)</label><input type="number" id="salTA" value="0"></div>
                    <div class="input-group"><label>HRA (‚Çπ)</label><input type="number" id="salHRA" value="0"></div>
                    <div class="input-group"><label>Others (‚Çπ)</label><input type="number" id="salOther" value="0"></div>
                    <div class="input-group"><label>EPF Fixed (‚Çπ)</label><input type="number" id="salPF" value="0"></div>
                    <div class="input-group"><label>ESI Fixed (‚Çπ)</label><input type="number" id="salESIFix" value="0"></div>
                </div>

                <div style="margin-top:20px; text-align:right">
                    <button class="btn">Save Employee</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // *** PASTE YOUR NEW APPS SCRIPT URL HERE ***
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz1-jJ8y_jC470Lz33aV33a90_8j3e9b0_EXAMPLE_URL/exec"; 
        
        let db = { depts: [], emps: [] };
        let currentUser = null;

        // --- API ---
        async function callAPI(action, payload={}) {
            document.getElementById('loader').classList.remove('hidden');
            try {
                const res = await fetch(SCRIPT_URL, { method: "POST", headers: { "Content-Type": "text/plain;charset=utf-8" }, body: JSON.stringify({ action, ...payload }) });
                const data = await res.json();
                document.getElementById('loader').classList.add('hidden');
                return data;
            } catch(e) { 
                document.getElementById('loader').classList.add('hidden');
                console.error(e); alert("Connection Error"); return {status:'error'}; 
            }
        }

        // --- INIT ---
        window.onload = async () => {
            const ys = document.getElementById('psYear');
            for(let y=2020; y<=2060; y++) { let o=document.createElement('option'); o.value=y; o.innerText=y; if(y==new Date().getFullYear()) o.selected=true; ys.appendChild(o); }

            const res = await callAPI('GET_ALL_DATA');
            if(res.status === 'success') {
                db.depts = res.data.departments; db.emps = res.data.employees;
                if(!res.isSetup) showView('view-setup'); else showView('view-login');
            }
        };

        // --- NAVIGATION ---
        function showView(id) { document.querySelectorAll('.hidden').forEach(e=>e.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
        function navTo(id) {
            document.querySelectorAll('.dashboard > .content > div').forEach(e=>e.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
            document.getElementById('nav-'+id.split('-')[1]).classList.add('active');
            if(id=='tab-emp') renderEmps();
            if(id=='tab-depts') renderDepts();
            if(id=='tab-pay') fillEmpSelect();
        }
        function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); if(!document.getElementById(id).classList.contains('hidden')) fillDeptSelect(); }

        // --- SETUP & LOGIN ---
        document.getElementById('setupForm').onsubmit = async (e) => { e.preventDefault(); await callAPI('SETUP_ORG', { name:document.getElementById('setupOrg').value, address:document.getElementById('setupAddr').value, email:document.getElementById('setupEmail').value, password:document.getElementById('setupPass').value }); location.reload(); };
        document.getElementById('loginForm').onsubmit = async (e) => {
            e.preventDefault();
            const res = await callAPI('LOGIN', { email:document.getElementById('loginEmail').value, password:document.getElementById('loginPass').value });
            if(res.status === 'success') {
                currentUser = res.user;
                document.getElementById('userDisplay').innerText = currentUser.name;
                document.getElementById('roleDisplay').innerText = currentUser.role;
                document.getElementById('pageTitle').innerText = res.orgName;
                document.querySelectorAll('.auth-container').forEach(e=>e.classList.add('hidden'));
                document.querySelector('.dashboard').classList.remove('hidden');
                document.getElementById('statEmp').innerText = db.emps.length;
                document.getElementById('statDept').innerText = db.depts.length;
            } else alert(res.msg);
        };

        // --- DEPARTMENTS ---
        document.getElementById('deptForm').onsubmit = async (e) => { e.preventDefault(); const p={id:Date.now(), entity:document.getElementById('newEntity').value, name:document.getElementById('newDept').value}; await callAPI('ADD_DEPT', p); db.depts.push(p); renderDepts(); e.target.reset(); };
        function renderDepts() { const tb=document.getElementById('deptTableBody'); tb.innerHTML=''; db.depts.forEach(d=>tb.innerHTML+=`<tr><td>${d.entity}</td><td>${d.name}</td><td><button class="btn btn-danger" onclick="delDept(${d.id})">X</button></td></tr>`); }
        async function delDept(id) { if(confirm('Delete?')) { await callAPI('DEL_DEPT', {id}); db.depts=db.depts.filter(d=>d.id!=id); renderDepts(); } }

        // --- EMPLOYEES ---
        function fillDeptSelect() { const s=document.getElementById('empDeptSelect'); s.innerHTML=''; db.depts.forEach(d=>s.innerHTML+=`<option value="${d.id}">${d.entity} - ${d.name}</option>`); }
        document.getElementById('empForm').onsubmit = async (e) => {
            e.preventDefault();
            const emp = {
                id:Date.now(), deptId:document.getElementById('empDeptSelect').value, code:'EMP'+Math.floor(Math.random()*9000),
                personal: { name:document.getElementById('empName').value, desg:document.getElementById('empDesg').value, doj:document.getElementById('empDOJ').value, status:'Active', aadhaar:document.getElementById('empAadhaar').value, pan:document.getElementById('empPAN').value, uan:document.getElementById('empUAN').value },
                bank: { name:document.getElementById('empBank').value, ac:document.getElementById('empAC').value, ifsc:document.getElementById('empIFSC').value, esi:document.getElementById('empESI').value },
                salary: { 
                    basic:document.getElementById('salBasic').value, da:document.getElementById('salDA').value, ta:document.getElementById('salTA').value, hra:document.getElementById('salHRA').value, other:document.getElementById('salOther').value, 
                    epf:document.getElementById('salPF').value, esi_fixed:document.getElementById('salESIFix').value 
                }
            };
            await callAPI('ADD_EMP', emp); db.emps.push(emp); toggleModal('modal-emp'); renderEmps();
        };
        function renderEmps() { const tb=document.getElementById('empTableBody'); tb.innerHTML=''; db.emps.forEach(e=>{ const d=db.depts.find(x=>x.id==e.deptId)||{entity:'-',name:'-'}; tb.innerHTML+=`<tr><td>${e.code}</td><td>${e.personal.name}</td><td>${d.entity}/${d.name}</td><td><button class="btn btn-danger" onclick="delEmp(${e.id})">X</button></td></tr>`; }); }
        async function delEmp(id) { if(confirm('Delete?')) { await callAPI('DEL_EMP', {id}); db.emps=db.emps.filter(e=>e.id!=id); renderEmps(); } }

        // --- PAYSLIP ---
        function fillEmpSelect() { const s=document.getElementById('psEmpSelect'); s.innerHTML='<option>-- Select --</option>'; db.emps.forEach(e=>s.innerHTML+=`<option value="${e.id}">${e.personal.name}</option>`); }
        function autoFetchEmp() {
            const id = document.getElementById('psEmpSelect').value;
            const emp = db.emps.find(e=>e.id==id);
            if(emp) {
                const d = db.depts.find(x=>x.id==emp.deptId);
                document.getElementById('psDisplayInfo').value = `${emp.personal.name} | ${emp.personal.desg} | ${d.entity}`;
                // Fill Hidden
                document.getElementById('fixBasic').value = emp.salary.basic;
                document.getElementById('fixDA').value = emp.salary.da;
                document.getElementById('fixTA').value = emp.salary.ta;
                document.getElementById('fixHRA').value = emp.salary.hra;
                document.getElementById('fixOther').value = emp.salary.other;
                document.getElementById('fixEPF').value = emp.salary.epf;
                document.getElementById('fixESI').value = emp.salary.esi_fixed;
            }
        }

        async function generatePDF() {
            const id = document.getElementById('psEmpSelect').value;
            if(!id || id.includes('Select')) return alert('Select Employee');
            
            const emp = db.emps.find(e=>e.id==id);
            const dept = db.depts.find(d=>d.id==emp.deptId);
            const month = document.getElementById('psMonth').value;
            const year = document.getElementById('psYear').value;

            // 1. Gather Figures
            const basic = parseFloat(document.getElementById('fixBasic').value)||0;
            const da = parseFloat(document.getElementById('fixDA').value)||0;
            const ta = parseFloat(document.getElementById('fixTA').value)||0;
            const hra = parseFloat(document.getElementById('fixHRA').value)||0;
            const other = parseFloat(document.getElementById('fixOther').value)||0;
            const gross = basic + da + ta + hra + other;

            // Deductions
            const epf = parseFloat(document.getElementById('fixEPF').value)||0;
            const mut = parseFloat(document.getElementById('psDedMUT').value)||0;
            const food = parseFloat(document.getElementById('psDedFood').value)||0;
            const tax = parseFloat(document.getElementById('psDedTax').value)||0;
            const med = parseFloat(document.getElementById('psDedMed').value)||0;
            const esi = parseFloat(document.getElementById('fixESI').value)||0; // Fixed from profile, or manual input could be added
            const welfare = parseFloat(document.getElementById('psDedWelfare').value)||0;
            const adv = parseFloat(document.getElementById('psDedAdv').value)||0;
            const lop = parseFloat(document.getElementById('psDedLOP').value)||0;
            
            const totalDed = epf + mut + food + tax + med + esi + welfare + adv + lop;
            const netPay = gross - totalDed;

            // 2. PDF GENERATION (Mirroring Image 2)
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Header (Letterhead style)
            doc.setFontSize(20); doc.setFont("helvetica", "bold");
            doc.text(dept.entity.toUpperCase(), 105, 15, null, null, "center");
            doc.setFontSize(10); doc.setFont("helvetica", "normal");
            doc.text("Organization Address Line Here", 105, 20, null, null, "center");
            doc.line(10, 24, 200, 24);

            doc.setFontSize(12); doc.setFont("helvetica", "bold");
            doc.text(`Payslip for ${month} ${year}`, 105, 32, null, null, "center");

            // Leave Summary & Attendance (Top Section)
            doc.setFontSize(10); doc.setFont("helvetica", "bold italic");
            doc.text("Leave Summary and Attendance Record:", 14, 42);
            
            const cl = document.getElementById('psCL').value;
            const sl = document.getElementById('psSL').value;
            const al = document.getElementById('psAL').value;
            const pres = document.getElementById('psPresent').value;
            const abs = document.getElementById('psAbsent').value;
            const paydays = document.getElementById('psPayDays').value;

            doc.autoTable({
                startY: 45,
                theme: 'plain',
                styles: { fontSize: 9, cellPadding: 1 },
                columnStyles: { 0: { fontStyle: 'bold', width: 35 }, 2: { fontStyle: 'bold', width: 35 } },
                body: [
                    ['Casual Leave:', cl, 'Present Days:', pres],
                    ['Sick Leave:', sl, 'Absent:', abs],
                    ['Annual Leave:', al, 'No.of Pay Days:', paydays]
                ]
            });

            // MAIN TABLE (Earnings vs Deductions)
            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 5,
                head: [['Earnings', 'Amount', 'Deductions', 'Amount']],
                body: [
                    ['Basic', basic.toFixed(2), 'EPF', epf.toFixed(2)],
                    ['DA', da.toFixed(2), 'MUT', mut.toFixed(2)],
                    ['TA', ta.toFixed(2), 'Food', food.toFixed(2)],
                    ['HRA', hra.toFixed(2), 'Income Tax', tax.toFixed(2)],
                    ['Other Allowances', other.toFixed(2), 'MED', med.toFixed(2)],
                    ['', '', 'ESI', esi.toFixed(2)],
                    ['', '', 'Retiree Welfare Fund', welfare.toFixed(2)],
                    ['', '', 'Advances/Loans/TDS', adv.toFixed(2)],
                    ['', '', 'Medical Exp/Other', '0.00'],
                    ['', '', 'Loss of Pay', lop.toFixed(2)],
                ],
                theme: 'grid',
                headStyles: { fillColor: [255, 255, 255], textColor: 0, fontStyle: 'bold', lineWidth: 0.1, lineColor: 0 },
                styles: { fontSize: 9, lineColor: 0, lineWidth: 0.1, cellPadding: 1.5 },
                columnStyles: { 0: { fontStyle: 'bold' }, 2: { fontStyle: 'bold' } }
            });

            // Totals Row
            let finalY = doc.lastAutoTable.finalY;
            doc.setLineWidth(0.1);
            doc.rect(14, finalY, 182, 8); // Box around totals
            doc.setFont("helvetica", "bold");
            doc.text("Gross Earnings", 16, finalY + 5.5);
            doc.text(gross.toFixed(2) + '/-', 65, finalY + 5.5);
            
            // Vertical line split
            doc.line(105, finalY, 105, finalY + 8); 
            
            doc.text("Total Deductions", 107, finalY + 5.5);
            doc.text(totalDed.toFixed(2) + '/-', 160, finalY + 5.5);

            // NET PAY
            doc.setFontSize(12);
            doc.text(`NET PAY : ‚Çπ ${netPay.toFixed(2)}/-`, 105, finalY + 18, null, null, "center");

            doc.save(`Payslip_${emp.personal.name}_${month}.pdf`);

            // Save to Cloud
            await callAPI('SAVE_PAYSLIP', {month, year, empName:emp.personal.name, empCode:emp.code, department:dept.name, entity:dept.entity, netPay});
            alert("Payslip Generated!");
        }
    </script>
</body>
</html>
