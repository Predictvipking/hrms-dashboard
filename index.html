<!DOCTYPE html>
<html lang="en" class="theme-blue">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Enterprise HRMS & Billing</title>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3135/3135768.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <script>
        tailwind.config = {
            theme: { extend: { colors: { primary: 'var(--color-primary)', secondary: 'var(--color-secondary)', surface: 'var(--color-surface)' } } }
        }
    </script>

    <style>
        :root { --color-primary: #2563eb; --color-secondary: #1e293b; --color-surface: #f8fafc; }
        .theme-blue { --color-primary: #2563eb; --color-secondary: #1e293b; }
        .theme-purple { --color-primary: #7c3aed; --color-secondary: #2e1065; }
        .theme-teal { --color-primary: #0d9488; --color-secondary: #134e4a; }
        .theme-dark { --color-primary: #6366f1; --color-secondary: #0f172a; --color-surface: #1e293b; background-color: #0f172a; color: #e2e8f0; }
        .theme-dark .bg-white { background-color: #1e293b; color: #e2e8f0; border-color: #334155; }
        .theme-dark input, .theme-dark select, .theme-dark textarea { background-color: #334155; border-color: #475569; color: white; }
        .sidebar-expanded { width: 16rem; }
        .sidebar-collapsed { width: 5rem; }
        .sidebar-collapsed span.label { display: none; }
        .sidebar-collapsed .nav-item { justify-content: center; }
        .sidebar-collapsed .nav-item:hover::after { content: attr(data-tooltip); position: absolute; left: 4.5rem; background: #334155; color: #fff; padding: 5px 10px; border-radius: 4px; font-size: 12px; white-space: nowrap; z-index: 50; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .toggle-checkbox:checked { right: 0; border-color: var(--color-primary); }
        .toggle-checkbox:checked + .toggle-label { background-color: var(--color-primary); }
    </style>
</head>
<body class="bg-surface text-gray-800 font-sans antialiased transition-colors duration-300">

    <div id="loader" class="fixed inset-0 bg-white/95 z-[9999] flex flex-col items-center justify-center">
        <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 text-gray-500 font-bold animate-pulse">Syncing System...</p>
    </div>

    <!-- AUTH SECTION -->
    <div id="auth-wrapper" class="min-h-screen flex items-center justify-center relative overflow-hidden bg-gray-900">
        <div class="absolute inset-0 bg-gradient-to-br from-primary to-secondary opacity-80"></div>
        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-20"></div>

        <!-- LOGIN CARD -->
        <div id="view-login" class="hidden w-full max-w-5xl bg-white rounded-2xl shadow-2xl relative z-10 flex overflow-hidden min-h-[600px]">
            <!-- Left: Brand & Info -->
            <div class="hidden md:flex w-1/2 bg-gradient-to-br from-primary to-secondary p-10 flex-col justify-between text-white">
                <div><h1 class="text-4xl font-bold mb-2 tracking-wide">Institute Pro</h1><p class="text-blue-200 text-lg font-light">Management & Billing Solution</p></div>
                <div class="space-y-6">
                    <div class="flex items-center gap-4"><div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur-sm"><i class="fa-solid fa-users text-2xl text-yellow-300"></i></div><div><h3 class="font-bold text-lg">HRMS & Payroll</h3><p class="text-xs opacity-70">Staff Tracking & Salary</p></div></div>
                    <div class="flex items-center gap-4"><div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur-sm"><i class="fa-solid fa-user-graduate text-2xl text-green-300"></i></div><div><h3 class="font-bold text-lg">Student Management</h3><p class="text-xs opacity-70">Fees & Batch Records</p></div></div>
                    <div class="flex items-center gap-4"><div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur-sm"><i class="fa-solid fa-file-invoice-dollar text-2xl text-pink-300"></i></div><div><h3 class="font-bold text-lg">IP Billing</h3><p class="text-xs opacity-70">Medical & Accounts</p></div></div>
                </div>
                <div class="border-t border-white/10 pt-4 mt-4"><p class="text-xs opacity-50 mb-2">© 2025 Enterprise Solutions</p><div class="flex flex-col gap-1"><div class="text-sm"><span class="opacity-70">Developer:</span> <span class="font-mono font-bold text-yellow-400 tracking-wide ml-1">Joel Roy</span></div><a href="mailto:vippredictking@zohomail.in" class="flex items-center gap-2 text-sm text-cyan-300 hover:text-white transition-colors w-fit p-1 -ml-1 rounded hover:bg-white/10"><i class="fa-solid fa-envelope"></i><span class="font-semibold italic">vippredictking@zohomail.in</span></a></div></div>
            </div>
            <!-- Right: Login Form -->
            <div class="w-full md:w-1/2 p-12 bg-white relative flex flex-col justify-center">
                <div class="flex mb-8 bg-gray-100 rounded-lg p-1">
                    <button onclick="switchLogin('admin')" id="tab-admin" class="w-1/2 py-2 rounded-md text-sm font-bold bg-white shadow text-primary transition">Admin/Staff</button>
                    <button onclick="switchLogin('employee')" id="tab-employee" class="w-1/2 py-2 rounded-md text-sm font-bold text-gray-500 hover:bg-white/50 transition">Employee Portal</button>
                </div>
                <div class="text-center mb-8"><h2 class="text-3xl font-bold text-gray-800" id="loginTitle">Staff Login</h2><p class="text-gray-400 text-sm mt-2">Secure access to your dashboard</p></div>
                <form id="loginForm" class="space-y-6">
                    <input type="hidden" id="loginType" value="ADMIN">
                    <div class="relative"><i class="fa-solid fa-envelope absolute left-4 top-3.5 text-gray-400"></i><input id="loginId" placeholder="Email Address" required class="pl-12 w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary outline-none transition"></div>
                    <div class="relative"><i class="fa-solid fa-lock absolute left-4 top-3.5 text-gray-400"></i><input type="password" id="loginPass" placeholder="Password" required class="pl-12 w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary outline-none transition"><i class="fa-solid fa-eye absolute right-4 top-3.5 text-gray-400 cursor-pointer hover:text-primary transition" onclick="togglePass('loginPass')"></i></div>
                    <button class="w-full py-3 bg-primary text-white rounded-xl font-bold shadow-lg hover:shadow-xl hover:brightness-110 transition transform hover:-translate-y-0.5">Secure Login</button>
                </form>
            </div>
        </div>

        <!-- SETUP -->
        <div id="view-setup" class="hidden w-full max-w-md bg-white rounded-2xl shadow-2xl relative z-10 p-8">
            <h1 class="text-2xl font-bold text-center text-primary mb-6">Initial Setup</h1>
            <form id="setupForm" class="space-y-4">
                <input id="setupOrg" placeholder="Organization Name" required class="w-full px-4 py-3 border rounded-lg">
                <input id="setupAddr" placeholder="Address" required class="w-full px-4 py-3 border rounded-lg">
                <input type="email" id="setupEmail" placeholder="Super Admin Email" required class="w-full px-4 py-3 border rounded-lg">
                <input type="password" id="setupPass" placeholder="Password" required class="w-full px-4 py-3 border rounded-lg">
                <button class="w-full py-3 bg-primary text-white rounded-lg font-bold">Initialize</button>
            </form>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="view-dashboard" class="hidden flex h-screen overflow-hidden">
        <aside id="sidebar" class="sidebar-expanded bg-secondary text-white flex flex-col shadow-2xl transition-all duration-300 relative z-20">
            <div class="p-6 border-b border-gray-700 font-bold text-xl flex items-center gap-3 overflow-hidden whitespace-nowrap"><div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center"><i class="fa-solid fa-layer-group"></i></div><span class="label">Institute Pro</span></div>
            <nav class="flex-1 py-6 px-3 space-y-2 overflow-y-auto no-scrollbar">
                <a onclick="navTo('tab-home')" id="nav-home" class="nav-item flex items-center px-4 py-3 rounded-xl cursor-pointer bg-white/10 text-white shadow-inner" data-tooltip="Dashboard"><i class="fa-solid fa-chart-pie w-5"></i> <span class="label ml-3 font-medium">Dashboard</span></a>
                <!-- Access Controlled Links -->
                <a onclick="navTo('tab-crm')" id="nav-crm" class="nav-item flex items-center px-4 py-3 rounded-xl cursor-pointer text-gray-400 hover:text-white hover:bg-white/5 transition" data-tooltip="CRM & Tools"><i class="fa-solid fa-toolbox w-5"></i> <span class="label ml-3">CRM & Tools</span></a>
                <a onclick="navTo('tab-student')" id="nav-student" class="nav-item flex items-center px-4 py-3 rounded-xl cursor-pointer text-gray-400 hover:text-white hover:bg-white/5 transition" data-tooltip="Student Fees"><i class="fa-solid fa-graduation-cap w-5"></i> <span class="label ml-3">Student Fees</span></a>
                <a onclick="navTo('tab-medical')" id="nav-medical" class="nav-item flex items-center px-4 py-3 rounded-xl cursor-pointer text-gray-400 hover:text-white hover:bg-white/5 transition" data-tooltip="Medical Billing"><i class="fa-solid fa-notes-medical w-5"></i> <span class="label ml-3">IP Billing</span></a>
                <div id="hr-links">
                    <a onclick="navTo('tab-emp')" id="nav-emp" class="nav-item flex items-center px-4 py-3 rounded-xl cursor-pointer text-gray-400 hover:text-white hover:bg-white/5 transition" data-tooltip="Staff"><i class="fa-solid fa-users w-5"></i> <span class="label ml-3">Staff</span></a>
                    <a onclick="navTo('tab-depts')" id="nav-depts" class="nav-item flex items-center px-4 py-3 rounded-xl cursor-pointer text-gray-400 hover:text-white hover:bg-white/5 transition" data-tooltip="Depts"><i class="fa-solid fa-building w-5"></i> <span class="label ml-3">Depts</span></a>
                    <a onclick="navTo('tab-pay')" id="nav-pay" class="nav-item flex items-center px-4 py-3 rounded-xl cursor-pointer text-gray-400 hover:text-white hover:bg-white/5 transition" data-tooltip="Payroll"><i class="fa-solid fa-file-invoice-dollar w-5"></i> <span class="label ml-3">Payroll</span></a>
                </div>
                <a onclick="navTo('tab-users')" id="nav-users" class="nav-item flex items-center px-4 py-3 rounded-xl cursor-pointer text-gray-400 hover:text-white hover:bg-white/5 transition" data-tooltip="Admin Console"><i class="fa-solid fa-users-gear w-5"></i> <span class="label ml-3">Admin Console</span></a>
            </nav>
            <div class="p-4 border-t border-gray-700"><button onclick="location.reload()" class="w-full py-2 bg-red-500/10 text-red-400 rounded-lg hover:bg-red-600 hover:text-white transition flex items-center justify-center gap-2"><i class="fa-solid fa-power-off"></i> <span class="label">Logout</span></button></div>
        </aside>

        <div class="flex-1 flex flex-col overflow-hidden relative">
            <header class="bg-white shadow-sm h-16 flex items-center justify-between px-6 z-10">
                <div class="flex items-center gap-4"><button onclick="toggleSidebar()" class="text-gray-500 hover:text-primary text-xl"><i class="fa-solid fa-bars"></i></button><h2 class="text-xl font-bold hidden md:block">Dashboard</h2></div>
                <div class="flex items-center gap-4">
                    <div class="flex bg-gray-100 rounded-full p-1 border"><button onclick="setTheme('theme-blue')" class="w-5 h-5 rounded-full bg-blue-600 m-1"></button><button onclick="setTheme('theme-purple')" class="w-5 h-5 rounded-full bg-purple-600 m-1"></button><button onclick="setTheme('theme-teal')" class="w-5 h-5 rounded-full bg-teal-600 m-1"></button><button onclick="setTheme('theme-dark')" class="w-5 h-5 rounded-full bg-gray-800 m-1"></button></div>
                    <div class="text-right hidden sm:block"><p id="userDisplay" class="text-sm font-bold">User</p><span id="roleDisplay" class="text-xs bg-primary/10 text-primary px-2 rounded-full font-bold">Role</span></div>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto p-6">
                <!-- HOME -->
                <div id="tab-home" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border"><p class="text-xs font-bold text-gray-500 uppercase">Staff</p><h3 id="statEmp" class="text-3xl font-bold mt-2">0</h3></div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border"><p class="text-xs font-bold text-gray-500 uppercase">Depts</p><h3 id="statDept" class="text-3xl font-bold mt-2">0</h3></div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border"><p class="text-xs font-bold text-gray-500 uppercase">Students</p><h3 class="text-3xl font-bold mt-2 text-indigo-600">-</h3></div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border"><p class="text-xs font-bold text-gray-500 uppercase">Collections</p><h3 class="text-3xl font-bold mt-2 text-green-600">₹ -</h3></div>
                    </div>
                </div>

                <!-- ADMIN CONSOLE (FIXED) -->
                <div id="tab-users" class="hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-2xl border col-span-1">
                            <h3 class="font-bold mb-4">Manage Access</h3>
                            <form id="userForm" class="space-y-3">
                                <input id="newUserName" placeholder="Name" required class="w-full border rounded p-2 text-sm">
                                <input id="newUserEmail" placeholder="Email (Login ID)" required class="w-full border rounded p-2 text-sm">
                                <div class="relative">
                                    <input type="password" id="newUserPass" placeholder="Password" required class="w-full border rounded p-2 text-sm">
                                    <i class="fa-solid fa-eye absolute right-3 top-2.5 text-gray-400 cursor-pointer" onclick="togglePass('newUserPass')"></i>
                                </div>
                                
                                <!-- FIXED ID HERE -->
                                <label class="text-xs font-bold text-gray-500">Role Title</label>
                                <input id="newUserRole" list="roles" placeholder="Select or Type Role" class="w-full border rounded p-2 text-sm">
                                <datalist id="roles"><option value="HR"><option value="MANAGER"><option value="FOUNDER"><option value="DIRECTOR"><option value="ADMIN"></datalist>
                                
                                <div class="bg-gray-50 p-2 rounded text-xs grid grid-cols-2 gap-2 border">
                                    <label><input type="checkbox" id="perm_dept"> Departments</label><label><input type="checkbox" id="perm_emp"> Staff Mgmt</label>
                                    <label><input type="checkbox" id="perm_pay"> Payroll</label><label><input type="checkbox" id="perm_hist"> History</label>
                                    <label><input type="checkbox" id="perm_crm"> CRM & Tools</label><label><input type="checkbox" id="perm_student"> Student Fees</label>
                                    <label><input type="checkbox" id="perm_med"> Medical Bill</label><label><input type="checkbox" id="perm_users"> User Mgmt</label>
                                </div>
                                <button id="saveUserBtn" class="w-full bg-primary text-white py-2 rounded font-bold">Create User</button>
                            </form>
                        </div>
                        <div class="bg-white p-6 rounded-2xl border col-span-2">
                            <h3 class="font-bold mb-2">System Users</h3>
                            <div class="overflow-x-auto"><table class="w-full text-sm"><thead class="bg-gray-50"><tr><th class="p-3">User</th><th class="p-3">Role</th><th class="p-3">Last Access</th><th class="text-right p-3">Act</th></tr></thead><tbody id="userTableBody"></tbody></table></div>
                        </div>
                    </div>
                </div>

                <!-- STUDENT FEES -->
                <div id="tab-student" class="hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border col-span-1">
                            <h3 class="font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-plus-circle text-primary"></i> Add Fee Entry</h3>
                            <form id="studentFeeForm" class="space-y-3">
                                <input id="stdBatch" placeholder="Batch / Course" required class="w-full border rounded p-2 text-sm">
                                <input id="stdName" placeholder="Student Name" required class="w-full border rounded p-2 text-sm">
                                <div class="grid grid-cols-2 gap-2">
                                    <input id="stdPaid" type="number" placeholder="Paid (₹)" required class="w-full border rounded p-2 text-sm font-bold text-green-600">
                                    <input id="stdPending" type="number" placeholder="Pending (₹)" class="w-full border rounded p-2 text-sm font-bold text-red-600">
                                </div>
                                <button class="w-full bg-primary text-white py-2 rounded font-bold">Record Transaction</button>
                            </form>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border col-span-2">
                            <h3 class="font-bold mb-4">Fee History</h3>
                            <div class="overflow-x-auto"><table class="w-full text-left text-sm"><thead class="bg-gray-50"><tr><th class="p-3">Date</th><th class="p-3">Student</th><th class="p-3">Batch</th><th class="p-3 text-green-600">Paid</th><th class="p-3 text-red-500">Pending</th><th class="p-3 text-right">By</th></tr></thead><tbody id="studentFeeBody"></tbody></table></div>
                        </div>
                    </div>
                </div>

                <!-- MEDICAL BILLING -->
                <div id="tab-medical" class="hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border col-span-1">
                            <h3 class="font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-file-medical text-red-500"></i> New IP Bill</h3>
                            <form id="medBillForm" class="space-y-3">
                                <input id="medEmpId" placeholder="Employee ID" required class="w-full border rounded p-2 text-sm">
                                <input id="medEmpName" placeholder="Employee/Patient Name" required class="w-full border rounded p-2 text-sm">
                                <div class="grid grid-cols-2 gap-2">
                                    <input id="medCash" type="number" placeholder="Cash (₹)" class="w-full border rounded p-2 text-sm">
                                    <input id="medOnline" type="number" placeholder="Online (₹)" class="w-full border rounded p-2 text-sm">
                                </div>
                                <textarea id="medRemarks" placeholder="Remarks / Treatment Details" rows="3" class="w-full border rounded p-2 text-sm"></textarea>
                                <button class="w-full bg-red-600 text-white py-2 rounded font-bold">Save Bill</button>
                            </form>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border col-span-2">
                            <h3 class="font-bold mb-4">Recent Medical Entries</h3>
                            <div class="overflow-x-auto"><table class="w-full text-left text-sm"><thead class="bg-gray-50"><tr><th class="p-3">Date</th><th class="p-3">ID</th><th class="p-3">Name</th><th class="p-3">Cash</th><th class="p-3">Online</th><th class="p-3">Remarks</th></tr></thead><tbody id="medBillBody"></tbody></table></div>
                        </div>
                    </div>
                </div>

                <!-- CRM & TOOLS -->
                <div id="tab-crm" class="hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border flex flex-col h-full"><h3 class="font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-sticky-note text-yellow-500"></i> Quick Notes</h3><div id="crmNotesList" class="flex-1 overflow-y-auto space-y-2 mb-4 pr-1 h-48"></div><div class="mt-auto"><textarea id="newNoteContent" placeholder="Write a note..." class="w-full border rounded p-2 text-sm h-20 mb-2"></textarea><button onclick="addCRMItem('NOTE')" class="w-full bg-primary text-white py-2 rounded text-sm font-bold">Save Note</button></div></div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border flex flex-col h-full"><h3 class="font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-link text-blue-500"></i> Shortcuts</h3><div id="crmLinksList" class="flex-1 overflow-y-auto space-y-2 mb-4 pr-1 h-48"></div><div class="mt-auto space-y-2"><input id="newLinkTitle" placeholder="Website Name" class="w-full border rounded p-2 text-sm"><input id="newLinkUrl" placeholder="URL (https://...)" class="w-full border rounded p-2 text-sm"><button onclick="addCRMItem('LINK')" class="w-full bg-primary text-white py-2 rounded text-sm font-bold">Save Link</button></div></div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border"><h3 class="font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-money-bill-wave text-green-500"></i> Cash Denomination</h3><div class="space-y-1 text-sm overflow-y-auto h-64" id="cashInputs"></div><div class="mt-4 pt-3 border-t flex justify-between items-center text-xl font-bold bg-green-50 p-3 rounded"><span>Total:</span><span class="text-green-700">₹ <span id="cashTotal">0</span></span></div></div>
                    </div>
                </div>

                <!-- Existing Tabs -->
                <div id="tab-emp" class="hidden"><div class="flex justify-between mb-4"><h3 class="text-xl font-bold">Staff</h3><button onclick="openEmpModal()" class="bg-primary text-white px-4 py-2 rounded-lg shadow">+ Add</button></div><div class="bg-white rounded-2xl shadow-sm border overflow-hidden"><table class="w-full text-left text-sm"><thead class="bg-gray-50"><tr><th class="p-4">Code</th><th class="p-4">Name</th><th class="p-4">Dept</th><th class="p-4 text-right">Act</th></tr></thead><tbody id="empTableBody" class="divide-y"></tbody></table></div></div>
                <div id="tab-depts" class="hidden"><div class="grid grid-cols-3 gap-6"><div class="bg-white p-6 rounded-2xl border col-span-1"><h3 class="font-bold mb-4">Add Dept</h3><form id="deptForm" class="space-y-3"><input id="newEntity" placeholder="Entity" required class="w-full border rounded p-2"><input id="newDept" placeholder="Dept Name" required class="w-full border rounded p-2"><textarea id="newDeptAddr" placeholder="Address" class="w-full border rounded p-2"></textarea><button class="w-full bg-primary text-white py-2 rounded">Save</button></form></div><div class="bg-white p-6 rounded-2xl border col-span-2"><table class="w-full text-sm"><thead class="bg-gray-50"><tr><th class="p-3">Entity</th><th class="p-3">Dept</th><th class="text-right p-3">Act</th></tr></thead><tbody id="deptTableBody"></tbody></table></div></div></div>
                <div id="tab-pay" class="hidden"><div class="max-w-5xl mx-auto bg-white rounded-2xl shadow-xl p-8 border border-gray-100"><h3 class="text-xl font-bold mb-6 border-b pb-4 flex items-center gap-2">Payroll Wizard</h3><div class="grid grid-cols-2 gap-6 mb-6"><div><label class="text-xs font-bold text-gray-500 uppercase">Select</label><select id="psEmpSelect" onchange="autoFetchEmp()" class="w-full border rounded-lg p-3 mt-1 bg-gray-50"><option>-- Search --</option></select></div><div><label class="text-xs font-bold text-gray-500 uppercase">Info</label><input id="psDisplayInfo" readonly class="w-full border rounded-lg p-3 mt-1 bg-gray-100"></div></div><div class="grid grid-cols-3 gap-4 mb-6"><select id="psMonth" class="w-full border rounded-lg p-2"><option>January</option><option>February</option><option>March</option><option>October</option><option>November</option><option>December</option></select><select id="psYear" class="w-full border rounded-lg p-2"></select><input type="number" id="psTotalDays" value="30" class="w-full border rounded-lg p-2"></div><div class="grid md:grid-cols-2 gap-6 mb-6"><div class="bg-blue-50/50 p-4 rounded-xl border"><h4 class="text-xs font-bold text-blue-700 mb-3">Attendance</h4><div class="grid grid-cols-4 gap-2 text-sm"><div><label>CL</label><input id="psCL" type="number" value="0" class="w-full border rounded p-1"></div><div><label>SL</label><input id="psSL" type="number" value="0" class="w-full border rounded p-1"></div><div><label>AL</label><input id="psAL" type="number" value="0" class="w-full border rounded p-1"></div><div><label>Paid</label><input id="psPayDays" type="number" value="30" class="w-full border rounded p-1 font-bold"></div><input type="hidden" id="psPresent" value="30"><input type="hidden" id="psAbsent" value="0"></div></div><div class="bg-red-50/50 p-4 rounded-xl border"><h4 class="text-xs font-bold text-red-700 mb-3">Deductions</h4><div class="grid grid-cols-3 gap-2 text-sm"><div><label>Food</label><input id="psDedFood" type="number" value="0" class="w-full border rounded p-1"></div><div><label>Loan</label><input id="psDedAdv" type="number" value="0" class="w-full border rounded p-1"></div><div><label>MUT</label><input id="psDedMUT" type="number" value="0" class="w-full border rounded p-1"></div><input type="hidden" id="psDedTax" value="0"><input type="hidden" id="psDedWelfare" value="0"><input type="hidden" id="psDedMed" value="0"><input type="hidden" id="psDedLOP" value="0"></div></div></div><input type="hidden" id="fixBasic"><input type="hidden" id="fixDA"><input type="hidden" id="fixTA"><input type="hidden" id="fixHRA"><input type="hidden" id="fixOther"><input type="hidden" id="fixEPF"><input type="hidden" id="fixESI"><button onclick="generatePDF('download')" class="w-full bg-primary text-white py-3 rounded-xl font-bold shadow-lg">Generate PDF</button></div></div>
                <div id="tab-history" class="hidden"><h3 class="text-xl font-bold mb-4">Records</h3><div class="bg-white rounded-2xl shadow-sm border overflow-hidden"><table class="w-full text-left text-sm"><thead class="bg-gray-50"><tr><th class="p-4">Date</th><th class="p-4">Month</th><th class="p-4">Employee</th><th class="p-4">Net Pay</th><th class="p-4 text-right">By</th></tr></thead><tbody id="historyTableBody" class="divide-y"></tbody></table></div></div>
            </main>
        </div>
    </div>

    <!-- MODAL: EMPLOYEE -->
    <div id="modal-emp" class="hidden fixed inset-0 bg-black/60 z-[100] flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto m-4 p-6">
            <div class="flex justify-between items-center mb-6 border-b pb-2"><h3 id="empModalTitle" class="text-xl font-bold">Employee Profile</h3><button onclick="document.getElementById('modal-emp').classList.add('hidden')" class="text-2xl">&times;</button></div>
            <form id="empForm" class="space-y-6">
                <input type="hidden" id="empId">
                <div class="grid md:grid-cols-3 gap-6">
                    <div class="relative bg-gray-50 p-2 rounded border"><div class="flex justify-between items-center mb-1"><label class="text-xs font-bold text-gray-500">CODE</label><label class="flex items-center"><input type="checkbox" id="codeToggle" class="mr-1 toggle-checkbox" onchange="toggleCodeInput()"><span class="text-xs">Manual</span></label></div><input id="empCode" class="w-full border rounded p-1.5 bg-blue-50 text-blue-700 font-bold" readonly value="Auto"></div>
                    <div><label class="text-xs font-bold">Name</label><input id="empName" required class="w-full mt-1 border rounded p-2"></div>
                    <div><label class="text-xs font-bold">Designation</label><select id="empDesgSelect" required class="w-full mt-1 border rounded p-2 bg-white"></select></div>
                    <div><label class="text-xs font-bold">Department</label><select id="empDeptSelect" required class="w-full mt-1 border rounded p-2 bg-white"></select></div>
                    <div><label class="text-xs font-bold">DOJ</label><input type="date" id="empDOJ" required class="w-full mt-1 border rounded p-2"></div>
                    <div><label class="text-xs font-bold">Status</label><select id="empStatus" class="w-full mt-1 border rounded p-2"><option>FullTime</option><option>Contract</option></select></div>
                </div>
                <div class="bg-yellow-50 p-3 rounded border border-yellow-200 grid grid-cols-2 gap-4"><div><label class="text-xs font-bold text-yellow-800">Login Email</label><input type="email" id="empEmail" class="w-full border rounded p-1 text-sm bg-white"></div><div><label class="text-xs font-bold text-yellow-800">Password</label><input type="text" id="empPass" value="123456" class="w-full border rounded p-1 text-sm bg-white"></div></div>
                <div class="grid grid-cols-3 gap-6 border-t pt-4"><div><label class="text-xs font-bold">Bank</label><input id="empBank" class="w-full border rounded p-2"></div><div><label class="text-xs font-bold">Account Number</label><input id="empAC" class="w-full border rounded p-2"></div><div><label class="text-xs font-bold">IFSC</label><input id="empIFSC" class="w-full border rounded p-2"></div><div><label class="text-xs font-bold">Aadhaar</label><input id="empAadhaar" class="w-full border rounded p-2"></div><div><label class="text-xs font-bold">UAN</label><input id="empUAN" class="w-full border rounded p-2"></div><div><label class="text-xs font-bold">ESI</label><input id="empESI" class="w-full border rounded p-2"></div></div>
                <div class="bg-gray-50 p-4 rounded border"><h4 class="text-sm font-bold text-green-600 mb-2">Salary</h4><div class="grid grid-cols-4 gap-4"><div><label class="text-xs">Basic</label><input type="number" id="salBasic" value="0" class="w-full border rounded p-2" oninput="calcEPF()"></div><div><label class="text-xs">DA</label><input type="number" id="salDA" value="0" class="w-full border rounded p-2" oninput="calcEPF()"></div><div><label class="text-xs">HRA</label><input type="number" id="salHRA" value="0" class="w-full border rounded p-2"></div><div><label class="text-xs">Other</label><input type="number" id="salOther" value="0" class="w-full border rounded p-2"></div><div><label class="text-xs text-red-500">EPF (Auto)</label><input type="number" id="salPF" value="0" class="w-full border rounded p-2 border-red-200" readonly></div><div><label class="text-xs text-red-500">ESI</label><input type="number" id="salESIFix" value="0" class="w-full border rounded p-2 border-red-200"></div><input type="hidden" id="salTA" value="0"></div></div>
                <div class="flex justify-end gap-3 pt-2"><button type="button" onclick="document.getElementById('modal-emp').classList.add('hidden')" class="px-6 py-2 rounded border font-bold">Cancel</button><button class="px-8 py-2 bg-primary text-white rounded font-bold">Save</button></div>
            </form>
        </div>
    </div>

    <script>
        // ============================================
        // PASTE YOUR SCRIPT URL HERE
        // ============================================
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx6kYgd5ZKAEsOR-kBYtjCZGJOeOwBaXymkm0-o6NXiTX5qotcNc9Tbgmk-yamZlFk/exec"; 
        
        let db = { depts: [], emps: [], desgs: [] };
        let currentUser = null;

        // UI
        function toggleSidebar() { const s=document.getElementById('sidebar'); s.classList.toggle('sidebar-expanded'); s.classList.toggle('sidebar-collapsed'); }
        function togglePass(id) { const i=document.getElementById(id); i.type = i.type==='password'?'text':'password'; }
        function setTheme(t) { document.documentElement.className=t; localStorage.setItem('hrms_theme',t); }
        function switchLogin(type) {
            document.getElementById('loginType').value = type.toUpperCase();
            const btnA = document.getElementById('tab-admin'), btnE = document.getElementById('tab-employee');
            if(type==='admin') { btnA.className="w-1/2 py-2 rounded-md text-sm font-bold bg-white shadow text-primary transition"; btnE.className="w-1/2 py-2 rounded-md text-sm font-bold text-gray-500 hover:bg-white/50 transition"; document.getElementById('loginTitle').innerText="Admin Portal"; document.getElementById('loginId').placeholder="Email Address"; }
            else { btnE.className="w-1/2 py-2 rounded-md text-sm font-bold bg-white shadow text-primary transition"; btnA.className="w-1/2 py-2 rounded-md text-sm font-bold text-gray-500 hover:bg-white/50 transition"; document.getElementById('loginTitle').innerText="Employee Portal"; document.getElementById('loginId').placeholder="Employee Code"; }
        }
        function toggleCodeInput() { const m=document.getElementById('codeToggle').checked; const i=document.getElementById('empCode'); if(m){i.readOnly=false;i.value='';i.className="w-full border rounded p-1.5 bg-green-50 text-green-700 font-bold";}else{i.readOnly=true;i.value='Auto';i.className="w-full border rounded p-1.5 bg-blue-50 text-blue-700 font-bold";} }
        function calcEPF() { const basic=parseFloat(document.getElementById('salBasic').value)||0; const da=parseFloat(document.getElementById('salDA').value)||0; let epf=(basic+da)*0.12; document.getElementById('salPF').value = epf>1800 ? 1800 : Math.round(epf); }

        function initCashCalc() { const denoms = [2000, 500, 200, 100, 50, 20, 10, 5, 2, 1]; const div = document.getElementById('cashInputs'); div.innerHTML = ''; denoms.forEach(d => { div.innerHTML += `<div class="flex justify-between items-center"><span class="font-bold w-12 text-right">${d} x</span><input type="number" class="border rounded p-1 w-20 text-center" oninput="calcCashTotal()" id="denom_${d}"><span class="w-20 text-right font-mono text-gray-600" id="val_${d}">0</span></div>`; }); }
        function calcCashTotal() { const denoms = [2000, 500, 200, 100, 50, 20, 10, 5, 2, 1]; let total = 0; denoms.forEach(d => { const count = document.getElementById(`denom_${d}`).value || 0; const val = count * d; document.getElementById(`val_${d}`).innerText = val; total += val; }); document.getElementById('cashTotal').innerText = total; }

        async function callAPI(a, p={}) { document.getElementById('loader').classList.remove('hidden'); try { const r = await fetch(SCRIPT_URL, { method: "POST", headers: { "Content-Type": "text/plain;charset=utf-8" }, body: JSON.stringify({ action: a, ...p }) }); const d = await r.json(); document.getElementById('loader').classList.add('hidden'); return d; } catch(e) { document.getElementById('loader').classList.add('hidden'); alert("Connection Error"); return {status:'error'}; } }

        window.onload = async () => {
            initCashCalc();
            if(localStorage.getItem('hrms_theme')) document.documentElement.className = localStorage.getItem('hrms_theme');
            const ys = document.getElementById('psYear'); for(let y=2020; y<=2060; y++) { let o=document.createElement('option'); o.value=y; o.innerText=y; if(y==new Date().getFullYear()) o.selected=true; ys.appendChild(o); }
            const res = await callAPI('GET_ALL_DATA');
            if(res.status === 'success') {
                db.depts = res.data.departments; db.emps = res.data.employees; db.desgs = res.data.designations;
                if(!res.isSetup) document.getElementById('view-setup').classList.remove('hidden'); else document.getElementById('view-login').classList.remove('hidden');
            }
        };

        function navTo(id) {
            const pm = {'tab-users':'manage_users','tab-depts':'manage_dept','tab-emp':'manage_emp','tab-pay':'generate_payslip','tab-history':'view_history','tab-crm':'view_crm','tab-student':'manage_student','tab-medical':'manage_medical'};
            if(currentUser.role!=='SUPER_ADMIN' && pm[id] && !currentUser.permissions[pm[id]]) { alert("Access Restricted"); return; }
            document.querySelectorAll('#view-dashboard main > div').forEach(e=>e.classList.add('hidden')); document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(e=>{e.classList.remove('bg-white/10','text-white','shadow-inner');e.classList.add('text-gray-400')});
            document.getElementById('nav-'+id.split('-')[1]).classList.add('bg-white/10','text-white','shadow-inner');
            if(id=='tab-emp')renderEmps(); if(id=='tab-depts')renderDepts(); if(id=='tab-pay')fillEmpSelect(); if(id=='tab-history')loadHistory(); if(id=='tab-users')loadUsers();
            if(id=='tab-student')loadStudents(); if(id=='tab-medical')loadMedical(); if(id=='tab-crm')loadCRM();
        }

        document.getElementById('setupForm').onsubmit = async (e) => { e.preventDefault(); await callAPI('SETUP_ORG', { name:document.getElementById('setupOrg').value, address:document.getElementById('setupAddr').value, email:document.getElementById('setupEmail').value, password:document.getElementById('setupPass').value }); location.reload(); };
        document.getElementById('loginForm').onsubmit = async (e) => {
            e.preventDefault();
            const res = await callAPI('LOGIN', { type:document.getElementById('loginType').value, loginId:document.getElementById('loginId').value.trim(), password:document.getElementById('loginPass').value.trim(), ip:'Online', device:navigator.platform });
            if(res.status === 'success') {
                currentUser = res.user;
                document.getElementById('auth-wrapper').classList.add('hidden');
                if(currentUser.role==='EMPLOYEE') { alert("Please use Employee Portal"); location.reload(); } else {
                    document.getElementById('view-dashboard').classList.remove('hidden');
                    document.getElementById('userDisplay').innerText = currentUser.name;
                    document.getElementById('roleDisplay').innerText = currentUser.role;
                    document.getElementById('statEmp').innerText = db.emps.length;
                    document.getElementById('statDept').innerText = db.depts.length;
                    if(!currentUser.permissions.manage_users && currentUser.role!=='SUPER_ADMIN') document.getElementById('nav-users').classList.add('hidden');
                }
            } else alert(res.msg);
        };

        // --- NEW MODULES ---
        document.getElementById('studentFeeForm').onsubmit = async (e) => { e.preventDefault(); await callAPI('ADD_STUDENT_FEE', { batch:document.getElementById('stdBatch').value, name:document.getElementById('stdName').value, paid:document.getElementById('stdPaid').value, pending:document.getElementById('stdPending').value, user:currentUser.name }); alert("Saved"); document.getElementById('studentFeeForm').reset(); loadStudents(); };
        async function loadStudents(){ const r=await callAPI('GET_STUDENT_FEES'); const b=document.getElementById('studentFeeBody'); b.innerHTML=''; if(r.status=='success') r.data.forEach(d=>{ b.innerHTML+=`<tr class="border-b"><td class="p-3">${new Date(d[0]).toLocaleDateString()}</td><td class="p-3 font-bold">${d[2]}</td><td class="p-3">${d[1]}</td><td class="p-3 text-green-600 font-bold">₹${d[3]}</td><td class="p-3 text-red-500">₹${d[4]}</td><td class="p-3 text-right text-xs">${d[5]}</td></tr>` }); }
        document.getElementById('medBillForm').onsubmit = async (e) => { e.preventDefault(); await callAPI('ADD_MED_BILL', { empId:document.getElementById('medEmpId').value, empName:document.getElementById('medEmpName').value, cash:document.getElementById('medCash').value, online:document.getElementById('medOnline').value, remarks:document.getElementById('medRemarks').value, user:currentUser.name }); alert("Saved"); document.getElementById('medBillForm').reset(); loadMedical(); };
        async function loadMedical(){ const r=await callAPI('GET_MED_BILLS'); const b=document.getElementById('medBillBody'); b.innerHTML=''; if(r.status=='success') r.data.forEach(d=>{ b.innerHTML+=`<tr class="border-b"><td class="p-3">${new Date(d[0]).toLocaleDateString()}</td><td class="p-3">${d[1]}</td><td class="p-3 font-bold">${d[2]}</td><td class="p-3">₹${d[3]}</td><td class="p-3">₹${d[4]}</td><td class="p-3 text-sm text-gray-500">${d[5]}</td></tr>` }); }
        async function loadCRM() { const res = await callAPI('GET_CRM_DATA'); const nList = document.getElementById('crmNotesList'); nList.innerHTML = ''; const lList = document.getElementById('crmLinksList'); lList.innerHTML = ''; if(res.status === 'success') { res.data.forEach(item => { if(item[0] === 'NOTE') { nList.innerHTML += `<div class="bg-yellow-50 p-2 rounded border border-yellow-200 text-sm mb-2"><p>${item[2]}</p><div class="flex justify-between mt-1 text-xs text-gray-400"><span>${item[3]}</span><button onclick="delCRM('${item[0]}','${item[1]}','${item[2]}')" class="text-red-400 hover:text-red-600">x</button></div></div>`; } else if(item[0] === 'LINK') { lList.innerHTML += `<div class="flex items-center justify-between p-2 hover:bg-gray-50 rounded"><a href="${item[2]}" target="_blank" class="text-blue-600 font-bold hover:underline"><i class="fa-solid fa-link mr-2"></i>${item[1]}</a><button onclick="delCRM('${item[0]}','${item[1]}','${item[2]}')" class="text-red-400 text-xs">x</button></div>`; } }); } }
        async function addCRMItem(type) { let title='', content=''; if(type==='NOTE') { content = document.getElementById('newNoteContent').value; title='Note'; } else { title = document.getElementById('newLinkTitle').value; content = document.getElementById('newLinkUrl').value; } if(!content) return alert("Content empty"); await callAPI('SAVE_CRM_ITEM', { type: type, title: title, content: content, owner: currentUser.name }); if(type==='NOTE') document.getElementById('newNoteContent').value=''; else { document.getElementById('newLinkTitle').value=''; document.getElementById('newLinkUrl').value=''; } loadCRM(); }
        async function delCRM(type, title, content) { if(confirm('Delete?')) { await callAPI('DEL_CRM_ITEM', {type, title, content}); loadCRM(); } }

        // Standard Functions
        document.getElementById('deptForm').onsubmit = async (e) => { e.preventDefault(); const p={id:Date.now(), entity:document.getElementById('newEntity').value, name:document.getElementById('newDept').value, address:document.getElementById('newDeptAddr').value}; await callAPI('ADD_DEPT', p); db.depts.push(p); renderDepts(); e.target.reset(); };
        function renderDepts() { const tb=document.getElementById('deptTableBody'); tb.innerHTML=''; db.depts.forEach(d=>tb.innerHTML+=`<tr class="border-b"><td class="p-3 font-bold">${d.entity}</td><td class="p-3">${d.name}<br><small class="text-gray-400">${d.address||''}</small></td><td class="p-3 text-right"><button onclick="delDept(${d.id})" class="text-red-500"><i class="fa-solid fa-trash"></i></button></td></tr>`); }
        async function delDept(id) { if(confirm('Delete?')) { await callAPI('DEL_DEPT', {id}); db.depts=db.depts.filter(d=>d.id!=id); renderDepts(); } }
        document.getElementById('desgForm').onsubmit=async(e)=>{e.preventDefault();const p={id:Date.now(),title:document.getElementById('newDesgTitle').value};await callAPI('ADD_DESG',p);db.desgs.push(p.title);alert("Added");}; 

        function openEmpModal(emp=null) { document.getElementById('modal-emp').classList.remove('hidden'); const deptSel=document.getElementById('empDeptSelect'); deptSel.innerHTML='<option value="">Select</option>'; db.depts.forEach(d=>deptSel.innerHTML+=`<option value="${d.id}">${d.entity} - ${d.name}</option>`); const desgSel=document.getElementById('empDesgSelect'); desgSel.innerHTML='<option value="">Select</option>'; db.desgs.forEach(d=>desgSel.innerHTML+=`<option>${d}</option>`); document.getElementById('codeToggle').checked=false; toggleCodeInput(); if(emp){ document.getElementById('empModalTitle').innerText='Edit'; document.getElementById('empId').value=emp.id; document.getElementById('empCode').value=emp.code; document.getElementById('codeToggle').checked=true; toggleCodeInput(); document.getElementById('empName').value=emp.personal.name; document.getElementById('empDeptSelect').value=emp.deptId; document.getElementById('empDesgSelect').value=emp.personal.desg; document.getElementById('empDOJ').value=emp.personal.doj.split('T')[0]; document.getElementById('empEmail').value=emp.personal.email||''; document.getElementById('empPass').value=emp.personal.password||''; document.getElementById('empBank').value=emp.bank.name; document.getElementById('empAC').value=emp.bank.ac; document.getElementById('empIFSC').value=emp.bank.ifsc; document.getElementById('salBasic').value=emp.salary.basic; document.getElementById('salDA').value=emp.salary.da; document.getElementById('salPF').value=emp.salary.epf; } else { document.getElementById('empForm').reset(); document.getElementById('empModalTitle').innerText='Add'; document.getElementById('empId').value=''; } }
        document.getElementById('empForm').onsubmit=async(e)=>{ e.preventDefault(); const id=document.getElementById('empId').value; let code=document.getElementById('empCode').value; if(!document.getElementById('codeToggle').checked) code='EMP'+Math.floor(1000+Math.random()*9000); const emp={ id:id?id:Date.now(), deptId:document.getElementById('empDeptSelect').value, code:code, personal:{ name:document.getElementById('empName').value, desg:document.getElementById('empDesgSelect').value, doj:document.getElementById('empDOJ').value, status:document.getElementById('empStatus').value, email:document.getElementById('empEmail').value, password:document.getElementById('empPass').value, aadhaar:document.getElementById('empAadhaar').value, pan:document.getElementById('empPAN').value, uan:document.getElementById('empUAN').value }, bank:{ name:document.getElementById('empBank').value, ac:document.getElementById('empAC').value, ifsc:document.getElementById('empIFSC').value, esi:document.getElementById('empESI').value }, salary:{ basic:document.getElementById('salBasic').value, da:document.getElementById('salDA').value, ta:document.getElementById('salTA').value, hra:document.getElementById('salHRA').value, other:document.getElementById('salOther').value, epf:document.getElementById('salPF').value, esi_fixed:document.getElementById('salESIFix').value } }; await callAPI('ADD_EMP', emp); if(id){const i=db.emps.findIndex(x=>x.id==id); if(i!==-1)db.emps[i]=emp;}else db.emps.push(emp); document.getElementById('modal-emp').classList.add('hidden'); renderEmps(); };
        function renderEmps() { const tb=document.getElementById('empTableBody'); tb.innerHTML=''; db.emps.forEach(e=>{ const d=db.depts.find(x=>x.id==e.deptId)||{name:'-'}; tb.innerHTML+=`<tr class="border-b hover:bg-gray-50"><td class="p-4 text-primary font-bold font-mono">${e.code}</td><td class="p-4 font-bold">${e.personal.name}<br><small class="text-gray-400">${e.personal.desg}</small></td><td class="p-4">${d.name}</td><td class="p-4 text-right"><button onclick='openEmpModal(${JSON.stringify(e)})' class="text-blue-500 mr-3"><i class="fa-solid fa-pen"></i></button><button onclick="delEmp(${e.id})" class="text-red-500"><i class="fa-solid fa-trash"></i></button></td></tr>`; }); }
        async function delEmp(id){ if(confirm('Delete?')) { await callAPI('DEL_EMP', {id}); db.emps=db.emps.filter(e=>e.id!=id); renderEmps(); } }

        // --- FIXED: USER MANAGEMENT (EDIT + CREATE) ---
        async function loadUsers(){
            const r=await callAPI('GET_SYS_USERS');
            const tb=document.getElementById('userTableBody'); tb.innerHTML='';
            if(r.status==='success') r.users.forEach(u=>{
                tb.innerHTML+=`<tr class="border-b"><td class="p-3 font-bold">${u.name}<br><small class="text-primary">${u.email}</small></td><td class="p-3"><span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">${u.role}</span></td><td class="p-3 text-xs text-gray-500">${u.last_device||'-'}</td><td class="p-3 text-right"><button onclick='editUser(${JSON.stringify(u)})' class="text-blue-500 mr-2"><i class="fa-solid fa-pen"></i></button><button onclick="delUser('${u.email}')" class="text-red-500"><i class="fa-solid fa-trash"></i></button></td></tr>`;
            });
        }
        
        function editUser(u) {
            document.getElementById('newUserName').value = u.name;
            document.getElementById('newUserEmail').value = u.email;
            document.getElementById('newUserPass').value = u.password;
            document.getElementById('newUserRole').value = u.role;
            const perms = u.permissions || {};
            document.getElementById('perm_dept').checked = perms.manage_dept;
            document.getElementById('perm_emp').checked = perms.manage_emp;
            document.getElementById('perm_pay').checked = perms.generate_payslip;
            document.getElementById('perm_hist').checked = perms.view_history;
            document.getElementById('perm_crm').checked = perms.view_crm;
            document.getElementById('perm_student').checked = perms.manage_student;
            document.getElementById('perm_med').checked = perms.manage_medical;
            document.getElementById('perm_users').checked = perms.manage_users;
            document.getElementById('saveUserBtn').innerText = "Update Access";
        }

        async function delUser(e){if(confirm('Delete?')){await callAPI('DEL_SYS_USER',{email:e});loadUsers();}}
        document.getElementById('userForm').onsubmit=async(e)=>{
            e.preventDefault();
            await callAPI('SAVE_SYS_USER',{
                name:document.getElementById('newUserName').value,
                email:document.getElementById('newUserEmail').value,
                password:document.getElementById('newUserPass').value,
                role:document.getElementById('newUserRole').value,
                permissions:{
                    view_dashboard:true,
                    manage_dept:document.getElementById('perm_dept').checked,
                    manage_emp:document.getElementById('perm_emp').checked,
                    generate_payslip:document.getElementById('perm_pay').checked,
                    view_history:document.getElementById('perm_hist').checked,
                    view_crm:document.getElementById('perm_crm').checked,
                    manage_student:document.getElementById('perm_student').checked,
                    manage_medical:document.getElementById('perm_med').checked,
                    manage_users:document.getElementById('perm_users').checked
                }
            });
            alert('User Access Updated');
            document.getElementById('userForm').reset();
            document.getElementById('saveUserBtn').innerText = "Create User";
            loadUsers();
        };

        function fillEmpSelect() { const s=document.getElementById('psEmpSelect'); s.innerHTML='<option>-- Select --</option>'; db.emps.forEach(e=>s.innerHTML+=`<option value="${e.id}">${e.personal.name} (${e.code})</option>`); }
        function autoFetchEmp() { const id=document.getElementById('psEmpSelect').value; const e=db.emps.find(x=>x.id==id); if(e){ const d=db.depts.find(x=>x.id==e.deptId); document.getElementById('psDisplayInfo').value=`${e.personal.name} | ${d.entity}`; document.getElementById('fixBasic').value=e.salary.basic; document.getElementById('fixDA').value=e.salary.da; document.getElementById('fixTA').value=e.salary.ta; document.getElementById('fixHRA').value=e.salary.hra; document.getElementById('fixOther').value=e.salary.other; document.getElementById('fixEPF').value=e.salary.epf; document.getElementById('fixESI').value=e.salary.esi_fixed; } }
        async function generatePDF(mode) {
            const id = document.getElementById('psEmpSelect').value; if(!id||id.includes('Select')) return alert('Select Employee');
            const emp=db.emps.find(e=>e.id==id), dept=db.depts.find(d=>d.id==emp.deptId), m=document.getElementById('psMonth').value, y=document.getElementById('psYear').value;
            const basic=Number(document.getElementById('fixBasic').value), da=Number(document.getElementById('fixDA').value), hra=Number(document.getElementById('fixHRA').value), other=Number(document.getElementById('fixOther').value); const gross=basic+da+hra+other;
            const epf=Number(document.getElementById('fixEPF').value), food=Number(document.getElementById('psDedFood').value), adv=Number(document.getElementById('psDedAdv').value); const netPay=gross-(epf+food+adv);
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            doc.setFont("times", "bold"); doc.setFontSize(22); doc.text(dept.entity, 105, 15, null, null, "center");
            doc.setFontSize(10); doc.setFont("times", "normal"); doc.text(dept.address||"Head Office", 105, 20, null, null, "center");
            doc.line(10, 25, 200, 25); doc.setFontSize(14); doc.setFont("times", "bold"); doc.text(`Payslip: ${m}-${y}`, 105, 35, null, null, "center");
            doc.autoTable({ startY: 45, head: [['Earnings', 'Amt', 'Deductions', 'Amt']], body: [['Basic', basic, 'EPF', epf], ['DA', da, 'Food', food], ['HRA', hra, 'Loan', adv], ['Other', other, '', '']], theme: 'grid' });
            let fy = doc.lastAutoTable.finalY; doc.setFontSize(12); doc.text(`NET PAY: Rs. ${netPay}`, 195, fy+15, null, null, "right");
            if(mode === 'download') doc.save(`Payslip_${emp.personal.name}.pdf`);
            await callAPI('SAVE_PAYSLIP', {month:m, year:y, empName:emp.personal.name, empCode:emp.code, netPay:netPay, user:currentUser.name});
        }
        async function loadHistory() { const res = await callAPI('GET_HISTORY', { role: currentUser.role, code: currentUser.code }); const tb = document.getElementById('historyTableBody'); tb.innerHTML = ''; if(res.status=='success' && res.history) { res.history.forEach(h => { tb.innerHTML += `<tr class="border-b"><td class="p-4 text-gray-500">${new Date(h[0]).toLocaleDateString()}</td><td class="p-4 font-bold">${h[1]}-${h[2]}</td><td class="p-4">${h[3]}</td><td class="p-4 text-green-600 font-bold">₹${h[5]}</td><td class="p-4 text-right text-xs text-gray-400">${h[6]}</td></tr>`; }); } }
    </script>
</body>
</html>
