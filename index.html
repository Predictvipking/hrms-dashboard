<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise HRMS AI</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- PDF Libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        .loader-dots div { animation: loader-dots1 0.6s infinite; }
        .loader-dots div:nth-child(1) { left: 8px; animation-delay: 0s; }
        .loader-dots div:nth-child(2) { left: 32px; animation-delay: 0.2s; }
        .loader-dots div:nth-child(3) { left: 56px; animation-delay: 0.4s; }
        @keyframes loader-dots1 { 0% { transform: scale(0); } 100% { transform: scale(1); } }
        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans antialiased">

    <!-- LOADER -->
    <div id="loader" class="fixed inset-0 bg-white/90 z-[9999] flex flex-col items-center justify-center backdrop-blur-sm">
        <div class="loader-dots block relative w-20 h-5 mt-2">
            <div class="absolute top-0 w-3 h-3 rounded-full bg-blue-600"></div>
            <div class="absolute top-0 w-3 h-3 rounded-full bg-blue-600"></div>
            <div class="absolute top-0 w-3 h-3 rounded-full bg-blue-600"></div>
        </div>
        <p class="mt-4 text-gray-500 font-medium animate-pulse">Syncing Secure Data...</p>
    </div>

    <!-- AUTH SECTION -->
    <div id="auth-wrapper" class="min-h-screen bg-slate-900 flex items-center justify-center p-4 relative overflow-hidden">
        <div class="absolute inset-0 opacity-20 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
        
        <!-- SETUP -->
        <div id="view-setup" class="hidden w-full max-w-md bg-white rounded-2xl shadow-2xl relative z-10">
            <div class="bg-blue-600 p-6 text-center rounded-t-2xl text-white">
                <h1 class="text-2xl font-bold">System Initialization</h1>
            </div>
            <form id="setupForm" class="p-8 space-y-4">
                <input id="setupOrg" placeholder="Organization Name" required class="w-full px-4 py-3 border rounded-lg">
                <input id="setupAddr" placeholder="Head Office Address" required class="w-full px-4 py-3 border rounded-lg">
                <input type="email" id="setupEmail" placeholder="Super Admin Email" required class="w-full px-4 py-3 border rounded-lg">
                <input type="password" id="setupPass" placeholder="Create Password" required class="w-full px-4 py-3 border rounded-lg">
                <button class="w-full py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700">Start System</button>
            </form>
        </div>

        <!-- LOGIN -->
        <div id="view-login" class="hidden w-full max-w-sm bg-white rounded-2xl shadow-2xl relative z-10">
            <div class="p-8 text-center pb-0">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-blue-50 mb-4 text-blue-600 text-3xl"><i class="fa-solid fa-shield-halved"></i></div>
                <h2 id="loginOrgName" class="text-2xl font-bold text-gray-800">Secure Login</h2>
            </div>
            <form id="loginForm" class="p-8 space-y-5">
                <div class="relative"><i class="fa-solid fa-user absolute left-4 top-3.5 text-gray-400"></i><input type="email" id="loginEmail" placeholder="Email ID" required class="pl-12 w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"></div>
                <div class="relative">
                    <i class="fa-solid fa-lock absolute left-4 top-3.5 text-gray-400"></i>
                    <input type="password" id="loginPass" placeholder="Password" required class="pl-12 w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                    <i class="fa-solid fa-eye absolute right-4 top-3.5 text-gray-400 cursor-pointer hover:text-blue-600" onclick="togglePass('loginPass')"></i>
                </div>
                <button class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 shadow-lg">Access Dashboard</button>
            </form>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="view-dashboard" class="hidden flex h-screen overflow-hidden bg-gray-100">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 bg-slate-900 text-white flex flex-col shadow-2xl transition-all duration-300">
            <div class="p-6 border-b border-slate-700 font-bold text-xl flex items-center gap-2"><i class="fa-brands fa-hive text-blue-400"></i> HRMS Pro</div>
            <nav class="flex-1 py-4 px-3 space-y-1 overflow-y-auto no-scrollbar">
                <a onclick="navTo('tab-home')" id="nav-home" class="nav-item flex items-center px-4 py-3 rounded-lg cursor-pointer bg-blue-600 text-white"><i class="fa-solid fa-chart-pie w-6 mr-2"></i> Dashboard</a>
                <a onclick="navTo('tab-users')" id="nav-users" class="nav-item flex items-center px-4 py-3 rounded-lg cursor-pointer text-slate-400 hover:text-white hover:bg-slate-800"><i class="fa-solid fa-users-gear w-6 mr-2"></i> Admin Console</a>
                <a onclick="navTo('tab-depts')" id="nav-depts" class="nav-item flex items-center px-4 py-3 rounded-lg cursor-pointer text-slate-400 hover:text-white hover:bg-slate-800"><i class="fa-solid fa-building w-6 mr-2"></i> Departments</a>
                <a onclick="navTo('tab-emp')" id="nav-emp" class="nav-item flex items-center px-4 py-3 rounded-lg cursor-pointer text-slate-400 hover:text-white hover:bg-slate-800"><i class="fa-solid fa-users w-6 mr-2"></i> Employees</a>
                <a onclick="navTo('tab-pay')" id="nav-pay" class="nav-item flex items-center px-4 py-3 rounded-lg cursor-pointer text-slate-400 hover:text-white hover:bg-slate-800"><i class="fa-solid fa-file-invoice-dollar w-6 mr-2"></i> Payslip</a>
                <a onclick="navTo('tab-history')" id="nav-history" class="nav-item flex items-center px-4 py-3 rounded-lg cursor-pointer text-slate-400 hover:text-white hover:bg-slate-800"><i class="fa-solid fa-clock-rotate-left w-6 mr-2"></i> History</a>
            </nav>
            <div class="p-4 border-t border-slate-700"><button onclick="location.reload()" class="w-full py-2 bg-red-600/20 text-red-300 hover:bg-red-600 hover:text-white rounded-lg transition"><i class="fa-solid fa-power-off mr-2"></i> Logout</button></div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="bg-white shadow-sm h-16 flex items-center justify-between px-6 z-10">
                <div class="flex items-center gap-4">
                    <button onclick="document.getElementById('sidebar').classList.toggle('-ml-64')" class="text-gray-500 hover:text-blue-600 text-xl"><i class="fa-solid fa-bars"></i></button>
                    <h2 class="text-xl font-bold text-gray-800 hidden md:block">Overview</h2>
                </div>
                <div class="flex items-center gap-3">
                    <div class="text-right"><p id="userDisplay" class="text-sm font-bold text-gray-900">User</p><span id="roleDisplay" class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full font-bold">Role</span></div>
                    <div class="h-9 w-9 rounded-full bg-blue-600 text-white flex items-center justify-center"><i class="fa-solid fa-user"></i></div>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto bg-gray-50 p-6">
                
                <!-- TAB: HOME -->
                <div id="tab-home" class="space-y-6">
                    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl p-6 text-white shadow-lg flex items-center justify-between">
                        <div><h3 class="text-lg font-bold"><i class="fa-solid fa-robot mr-2"></i> AI Insight</h3><p id="aiText" class="text-indigo-100 text-sm mt-1">Analyzing Data...</p></div>
                        <i class="fa-solid fa-wand-magic-sparkles text-4xl opacity-50"></i>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100"><p class="text-xs font-bold text-gray-500 uppercase">Total Staff</p><h3 id="statEmp" class="text-3xl font-bold text-gray-800">0</h3></div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100"><p class="text-xs font-bold text-gray-500 uppercase">Departments</p><h3 id="statDept" class="text-3xl font-bold text-gray-800">0</h3></div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100"><p class="text-xs font-bold text-gray-500 uppercase">Cloud Status</p><h3 class="text-lg font-bold text-green-600 flex items-center gap-2 mt-1"><span class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></span> Connected</h3></div>
                    </div>
                </div>

                <!-- TAB: ADMIN CONSOLE (User Mgmt) -->
                <div id="tab-users" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Create/Edit User Form -->
                    <div class="bg-white p-6 rounded-xl shadow-sm lg:col-span-1 border">
                        <h3 class="font-bold mb-4 flex items-center gap-2 text-blue-800"><i class="fa-solid fa-user-shield"></i> Manage Access</h3>
                        <form id="userForm" class="space-y-3">
                            <input id="newUserName" placeholder="Full Name" required class="w-full border rounded-lg p-2 text-sm">
                            <input type="email" id="newUserEmail" placeholder="Email (Login ID)" required class="w-full border rounded-lg p-2 text-sm bg-gray-50">
                            <div class="relative">
                                <input type="password" id="newUserPass" placeholder="Password" required class="w-full border rounded-lg p-2 text-sm">
                                <i class="fa-solid fa-eye absolute right-3 top-2.5 text-gray-400 cursor-pointer hover:text-blue-600" onclick="togglePass('newUserPass')"></i>
                            </div>
                            <select id="newUserRole" class="w-full border rounded-lg p-2 text-sm bg-white"><option value="HR">HR Manager</option><option value="MANAGER">Dept Head</option><option value="ACCOUNTANT">Accountant</option></select>
                            
                            <div class="bg-gray-50 p-3 rounded-lg text-sm border">
                                <p class="text-xs font-bold text-gray-500 mb-2">PERMISSIONS</p>
                                <div class="grid grid-cols-2 gap-2">
                                    <label><input type="checkbox" id="perm_dept"> Depts</label>
                                    <label><input type="checkbox" id="perm_emp"> Staff</label>
                                    <label><input type="checkbox" id="perm_pay"> Payroll</label>
                                    <label><input type="checkbox" id="perm_hist"> History</label>
                                </div>
                            </div>
                            <button class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold hover:bg-blue-700">Save / Update User</button>
                        </form>
                    </div>
                    <!-- User Table -->
                    <div class="bg-white p-6 rounded-xl shadow-sm lg:col-span-2 border overflow-x-auto">
                        <table class="w-full text-left text-sm whitespace-nowrap">
                            <thead class="bg-gray-50 text-gray-500 font-bold uppercase"><tr><th class="p-3">User</th><th class="p-3">Role</th><th class="p-3">Last Access (IP/Device)</th><th class="p-3 text-right">Action</th></tr></thead>
                            <tbody id="userTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- TAB: DEPARTMENTS -->
                <div id="tab-depts" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border lg:col-span-1">
                        <h3 class="font-bold mb-4">Add Department</h3>
                        <form id="deptForm" class="space-y-3">
                            <input id="newEntity" placeholder="Entity (e.g. NIDS)" required class="w-full border rounded-lg p-2">
                            <input id="newDept" placeholder="Department Name" required class="w-full border rounded-lg p-2">
                            <textarea id="newDeptAddr" placeholder="Address (For Payslip Header)" rows="2" class="w-full border rounded-lg p-2"></textarea>
                            <button class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold">Add Department</button>
                        </form>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border lg:col-span-2"><table class="w-full text-left text-sm"><thead class="bg-gray-50 uppercase"><tr><th class="p-3">Entity</th><th class="p-3">Dept</th><th class="p-3 text-right">Action</th></tr></thead><tbody id="deptTableBody"></tbody></table></div>
                </div>

                <!-- TAB: EMPLOYEES -->
                <div id="tab-emp" class="hidden">
                    <div class="flex justify-between mb-4"><h3 class="text-xl font-bold">Employees</h3><button onclick="openEmpModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700">+ Add Employee</button></div>
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden border"><table class="w-full text-left text-sm"><thead class="bg-gray-50 uppercase"><tr><th class="p-4">Code</th><th class="p-4">Name</th><th class="p-4">Dept</th><th class="p-4 text-right">Actions</th></tr></thead><tbody id="empTableBody" class="divide-y"></tbody></table></div>
                </div>

                <!-- TAB: PAYSLIP -->
                <div id="tab-pay" class="hidden">
                    <div class="max-w-5xl mx-auto bg-white rounded-xl shadow-lg p-8 border">
                        <h3 class="text-xl font-bold mb-6 border-b pb-2">Payslip Generator</h3>
                        <div class="grid grid-cols-2 gap-6 mb-4">
                            <div><label class="text-xs font-bold text-gray-500 uppercase">Employee</label><select id="psEmpSelect" onchange="autoFetchEmp()" class="w-full border rounded-lg p-2 mt-1 bg-gray-50"><option>-- Search --</option></select></div>
                            <div><label class="text-xs font-bold text-gray-500 uppercase">Profile</label><input id="psDisplayInfo" readonly class="w-full border rounded-lg p-2 mt-1 bg-gray-100"></div>
                        </div>
                        <div class="grid grid-cols-3 gap-4 mb-4">
                            <div><label class="text-xs font-bold text-gray-500">Month</label><select id="psMonth" class="w-full border rounded p-2"><option>January</option><option>February</option><option>March</option><option>April</option><option>May</option><option>June</option><option>July</option><option>August</option><option>September</option><option>October</option><option>November</option><option>December</option></select></div>
                            <div><label class="text-xs font-bold text-gray-500">Year</label><select id="psYear" class="w-full border rounded p-2"></select></div>
                            <div><label class="text-xs font-bold text-gray-500">Total Days</label><input type="number" id="psTotalDays" value="30" class="w-full border rounded p-2"></div>
                        </div>
                        
                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                                <h4 class="text-xs font-bold text-blue-800 uppercase mb-2">Attendance</h4>
                                <div class="grid grid-cols-2 gap-2 text-sm">
                                    <div><label>CL</label><input type="number" id="psCL" value="0" class="w-full border rounded p-1"></div>
                                    <div><label>SL</label><input type="number" id="psSL" value="0" class="w-full border rounded p-1"></div>
                                    <div><label>AL</label><input type="number" id="psAL" value="0" class="w-full border rounded p-1"></div>
                                    <div><label>Absent</label><input type="number" id="psAbsent" value="0" class="w-full border rounded p-1"></div>
                                    <div class="col-span-2"><label class="text-blue-700 font-bold">Paid Days</label><input type="number" id="psPayDays" value="30" class="w-full border rounded p-1 font-bold"></div>
                                </div>
                            </div>
                            <div class="bg-red-50 p-4 rounded-lg border border-red-100">
                                <h4 class="text-xs font-bold text-red-800 uppercase mb-2">Deductions (Monthly)</h4>
                                <div class="grid grid-cols-2 gap-2 text-sm">
                                    <div><label>Food</label><input type="number" id="psDedFood" value="0" class="w-full border rounded p-1"></div>
                                    <div><label>Loan/Adv</label><input type="number" id="psDedAdv" value="0" class="w-full border rounded p-1"></div>
                                    <div><label>Tax/TDS</label><input type="number" id="psDedTax" value="0" class="w-full border rounded p-1"></div>
                                    <div><label>Welfare</label><input type="number" id="psDedWelfare" value="0" class="w-full border rounded p-1"></div>
                                    <div><label>MUT</label><input type="number" id="psDedMUT" value="0" class="w-full border rounded p-1"></div>
                                    <div><label>LOP Amt</label><input type="number" id="psDedLOP" value="0" class="w-full border rounded p-1"></div>
                                    <input type="hidden" id="psDedMed" value="0">
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="fixBasic"><input type="hidden" id="fixDA"><input type="hidden" id="fixTA"><input type="hidden" id="fixHRA"><input type="hidden" id="fixOther"><input type="hidden" id="fixEPF"><input type="hidden" id="fixESI">
                        <button onclick="generatePDF()" class="w-full mt-6 bg-slate-800 text-white py-3 rounded-lg font-bold hover:bg-slate-900 shadow-lg">Generate Payslip</button>
                    </div>
                </div>

                <!-- TAB: HISTORY -->
                <div id="tab-history" class="hidden">
                    <h3 class="text-xl font-bold mb-4">Payslip History</h3>
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden border"><table class="w-full text-left text-sm"><thead class="bg-gray-50 uppercase"><tr><th class="p-4">Date</th><th class="p-4">Period</th><th class="p-4">Employee</th><th class="p-4">Net Pay</th><th class="p-4 text-right">User</th></tr></thead><tbody id="historyTableBody" class="divide-y"></tbody></table></div>
                </div>
            </main>
        </div>
    </div>

    <!-- MODAL: ADD EMPLOYEE (With Auto/Manual Switch) -->
    <div id="modal-emp" class="hidden fixed inset-0 bg-black/60 z-[100] flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto m-4 p-6 animate-fade-in">
            <div class="flex justify-between items-center mb-6 border-b pb-2">
                <h3 id="empModalTitle" class="text-xl font-bold">Add Employee</h3>
                <button onclick="document.getElementById('modal-emp').classList.add('hidden')" class="text-2xl text-gray-400 hover:text-red-500">&times;</button>
            </div>
            <form id="empForm" class="space-y-6">
                <input type="hidden" id="empId">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- CODE SWITCH -->
                    <div class="relative bg-blue-50 p-2 rounded-lg border border-blue-100">
                        <div class="flex justify-between items-center mb-1">
                            <label class="text-xs font-bold text-blue-800">EMP CODE</label>
                            <div class="flex items-center">
                                <label for="codeToggle" class="flex items-center cursor-pointer">
                                    <div class="relative">
                                        <input type="checkbox" id="codeToggle" class="sr-only" onchange="toggleCodeInput()">
                                        <div class="block bg-gray-300 w-8 h-5 rounded-full"></div>
                                        <div class="dot absolute left-1 top-1 bg-white w-3 h-3 rounded-full transition transform"></div>
                                    </div>
                                    <div class="ml-2 text-xs text-gray-600 font-medium" id="toggleLabel">Manual</div>
                                </label>
                            </div>
                        </div>
                        <input id="empCode" class="w-full border rounded p-1.5 text-sm" placeholder="Type Code">
                    </div>

                    <div><label class="text-xs font-bold text-gray-500">Full Name</label><input id="empName" required class="w-full mt-1 border rounded p-2"></div>
                    <div><label class="text-xs font-bold text-gray-500">Department</label><select id="empDeptSelect" required class="w-full mt-1 border rounded p-2 bg-white"></select></div>
                    <div><label class="text-xs font-bold text-gray-500">Designation</label><input id="empDesg" required class="w-full mt-1 border rounded p-2"></div>
                    <div><label class="text-xs font-bold text-gray-500">DOJ</label><input type="date" id="empDOJ" required class="w-full mt-1 border rounded p-2"></div>
                    <div><label class="text-xs font-bold text-gray-500">Status</label><select id="empStatus" class="w-full mt-1 border rounded p-2"><option>FullTime</option><option>Contract</option></select></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 border-t pt-4">
                    <div><label class="text-xs font-bold text-gray-500">Bank Name</label><input id="empBank" class="w-full mt-1 border rounded p-2"></div>
                    <div><label class="text-xs font-bold text-gray-500">Account No</label><input id="empAC" class="w-full mt-1 border rounded p-2"></div>
                    <div><label class="text-xs font-bold text-gray-500">IFSC</label><input id="empIFSC" class="w-full mt-1 border rounded p-2"></div>
                    <div><label class="text-xs font-bold text-gray-500">Aadhaar</label><input id="empAadhaar" class="w-full mt-1 border rounded p-2"></div>
                    <div><label class="text-xs font-bold text-gray-500">UAN</label><input id="empUAN" class="w-full mt-1 border rounded p-2"></div>
                    <div><label class="text-xs font-bold text-gray-500">ESI No</label><input id="empESI" class="w-full mt-1 border rounded p-2"></div>
                </div>
                <div class="bg-gray-50 p-4 rounded border">
                    <h4 class="text-sm font-bold text-green-600 mb-2">Salary Structure</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div><label class="text-xs font-bold text-gray-500">Basic</label><input type="number" id="salBasic" value="0" class="w-full border rounded p-2"></div>
                        <div><label class="text-xs font-bold text-gray-500">DA</label><input type="number" id="salDA" value="0" class="w-full border rounded p-2"></div>
                        <div><label class="text-xs font-bold text-gray-500">TA</label><input type="number" id="salTA" value="0" class="w-full border rounded p-2"></div>
                        <div><label class="text-xs font-bold text-gray-500">HRA</label><input type="number" id="salHRA" value="0" class="w-full border rounded p-2"></div>
                        <div><label class="text-xs font-bold text-gray-500">Other</label><input type="number" id="salOther" value="0" class="w-full border rounded p-2"></div>
                        <div><label class="text-xs font-bold text-red-500">EPF Fix</label><input type="number" id="salPF" value="0" class="w-full border-red-200 bg-red-50 border rounded p-2"></div>
                        <div><label class="text-xs font-bold text-red-500">ESI Fix</label><input type="number" id="salESIFix" value="0" class="w-full border-red-200 bg-red-50 border rounded p-2"></div>
                    </div>
                </div>
                <div class="flex justify-end gap-3 pt-2">
                    <button type="button" onclick="document.getElementById('modal-emp').classList.add('hidden')" class="px-6 py-2 rounded border font-bold hover:bg-gray-50">Cancel</button>
                    <button class="px-8 py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script>
        // *** CONFIGURATION ***
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyA3Py_jTgXcZbNzHUINoaMUEAc_Qu-yXR6VhbwlBJN3hxwBRxg1OAVXOp9RBP1uaaa/exec";
        
        let db = { depts: [], emps: [], users: [] };
        let currentUser = null;

        // UI HELPERS
        function togglePass(id) { const i=document.getElementById(id); i.type = i.type==='password'?'text':'password'; }
        
        function toggleCodeInput() {
            const isManual = document.getElementById('codeToggle').checked;
            const input = document.getElementById('empCode');
            const label = document.getElementById('toggleLabel');
            
            if(isManual) {
                input.readOnly = false;
                input.value = '';
                input.placeholder = "Type Code (e.g. EMP001)";
                input.classList.remove('bg-gray-100', 'cursor-not-allowed');
                label.innerText = "Manual";
            } else {
                input.readOnly = true;
                input.value = 'Auto-Generated';
                input.classList.add('bg-gray-100', 'cursor-not-allowed');
                label.innerText = "Auto";
            }
        }
        // Custom style for toggle switch
        document.head.insertAdjacentHTML("beforeend", `<style>.toggle-checkbox:checked + .block { background-color: #2563eb; } .toggle-checkbox:checked + .block + .dot { transform: translateX(100%); }</style>`)

        // API
        async function callAPI(action, payload={}) {
            document.getElementById('loader').classList.remove('hidden');
            try {
                const res = await fetch(SCRIPT_URL, { method: "POST", headers: { "Content-Type": "text/plain;charset=utf-8" }, body: JSON.stringify({ action, ...payload }) });
                const data = await res.json();
                document.getElementById('loader').classList.add('hidden');
                return data;
            } catch(e) { document.getElementById('loader').classList.add('hidden'); alert("Connection Error"); return {status:'error'}; }
        }

        // IP TRACKING
        async function getIP() {
            try { const r = await fetch('https://api.ipify.org?format=json'); const d = await r.json(); return d.ip; } 
            catch(e) { return 'Unknown'; }
        }

        // INIT
        window.onload = async () => {
            const ys = document.getElementById('psYear'); for(let y=2020; y<=2060; y++) { let o=document.createElement('option'); o.value=y; o.innerText=y; if(y==new Date().getFullYear()) o.selected=true; ys.appendChild(o); }
            const res = await callAPI('GET_ALL_DATA');
            if(res.status === 'success') {
                db.depts = res.data.departments; db.emps = res.data.employees;
                document.getElementById('auth-wrapper').classList.remove('hidden');
                if(!res.isSetup) document.getElementById('view-setup').classList.remove('hidden'); else document.getElementById('view-login').classList.remove('hidden');
            }
        };

        function navTo(id) {
            const permMap = {'tab-users':'manage_users', 'tab-depts':'manage_dept', 'tab-emp':'manage_emp', 'tab-pay':'generate_payslip', 'tab-history':'view_history'};
            if(currentUser.role !== 'SUPER_ADMIN' && permMap[id] && !currentUser.permissions[permMap[id]]) { alert("Access Denied"); return; }
            document.querySelectorAll('#view-dashboard main > div').forEach(e=>e.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(e => { e.classList.remove('bg-blue-600','text-white'); e.classList.add('text-slate-400'); });
            document.getElementById('nav-'+id.split('-')[1]).classList.add('bg-blue-600','text-white');
            if(id=='tab-emp') renderEmps();
            if(id=='tab-depts') renderDepts();
            if(id=='tab-pay') fillEmpSelect();
            if(id=='tab-history') loadHistory();
            if(id=='tab-users') loadSystemUsers();
        }

        // AUTH HANDLERS
        document.getElementById('setupForm').onsubmit = async (e) => { e.preventDefault(); await callAPI('SETUP_ORG', { name:document.getElementById('setupOrg').value, address:document.getElementById('setupAddr').value, email:document.getElementById('setupEmail').value, password:document.getElementById('setupPass').value }); location.reload(); };
        
        document.getElementById('loginForm').onsubmit = async (e) => {
            e.preventDefault();
            const ip = await getIP();
            const device = navigator.platform + " (" + navigator.userAgent.split(')')[0] + ")";
            const res = await callAPI('LOGIN', { email:document.getElementById('loginEmail').value, password:document.getElementById('loginPass').value, ip: ip, device: device });
            if(res.status === 'success') {
                currentUser = res.user;
                document.getElementById('userDisplay').innerText = currentUser.name;
                document.getElementById('roleDisplay').innerText = currentUser.role;
                document.getElementById('auth-wrapper').classList.add('hidden');
                document.getElementById('view-dashboard').classList.remove('hidden');
                document.getElementById('statEmp').innerText = db.emps.length;
                document.getElementById('statDept').innerText = db.depts.length;
                if(currentUser.role!=='SUPER_ADMIN') document.getElementById('nav-users').classList.add('hidden');
            } else alert(res.msg);
        };

        // ADMIN CONSOLE: USER MGMT
        async function loadSystemUsers() {
            const res = await callAPI('GET_SYS_USERS');
            const tb = document.getElementById('userTableBody'); tb.innerHTML = '';
            if(res.status=='success') {
                res.users.forEach(u => {
                    const tracking = `<div class="text-xs text-gray-500"><i class="fa-solid fa-desktop mr-1"></i>${u.last_device || '-'}<br><i class="fa-solid fa-location-dot mr-1"></i>${u.last_ip || '-'}</div>`;
                    tb.innerHTML += `<tr class="border-b hover:bg-gray-50"><td class="p-3 font-bold">${u.name}<br><span class="text-xs text-blue-500 font-normal">${u.email}</span></td><td class="p-3"><span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">${u.role}</span></td><td class="p-3">${tracking}</td><td class="p-3 text-right"><button onclick='editUser(${JSON.stringify(u)})' class="text-blue-500 hover:text-blue-700 mr-2" title="Edit/Reset"><i class="fa-solid fa-pen-to-square"></i></button><button onclick="delUser('${u.email}')" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i></button></td></tr>`;
                });
            }
        }

        document.getElementById('userForm').onsubmit = async (e) => {
            e.preventDefault();
            const payload = {
                name: document.getElementById('newUserName').value,
                email: document.getElementById('newUserEmail').value,
                password: document.getElementById('newUserPass').value,
                role: document.getElementById('newUserRole').value,
                permissions: { view_dashboard:true, manage_dept:document.getElementById('perm_dept').checked, manage_emp:document.getElementById('perm_emp').checked, generate_payslip:document.getElementById('perm_pay').checked, view_history:document.getElementById('perm_hist').checked }
            };
            await callAPI('SAVE_SYS_USER', payload);
            alert("User Saved!");
            document.getElementById('userForm').reset();
            loadSystemUsers(); // Refresh Table without Reload
        };

        function editUser(u) {
            document.getElementById('newUserName').value = u.name;
            document.getElementById('newUserEmail').value = u.email;
            document.getElementById('newUserPass').value = u.password;
            document.getElementById('newUserRole').value = u.role;
            alert("User loaded in form. Change details and click Save.");
        }
        async function delUser(email) { if(confirm('Delete User?')) { await callAPI('DEL_SYS_USER', {email}); loadSystemUsers(); } }

        // DEPARTMENTS
        document.getElementById('deptForm').onsubmit = async (e) => { e.preventDefault(); const p={id:Date.now(), entity:document.getElementById('newEntity').value, name:document.getElementById('newDept').value, address:document.getElementById('newDeptAddr').value}; await callAPI('ADD_DEPT', p); db.depts.push(p); renderDepts(); e.target.reset(); };
        function renderDepts() { const tb=document.getElementById('deptTableBody'); tb.innerHTML=''; db.depts.forEach(d=>tb.innerHTML+=`<tr class="border-b"><td class="p-3 font-bold">${d.entity}</td><td class="p-3">${d.name}<br><span class="text-xs text-gray-400">${d.address||''}</span></td><td class="p-3 text-right"><button onclick="delDept(${d.id})" class="text-red-500"><i class="fa-solid fa-trash"></i></button></td></tr>`); }
        async function delDept(id) { if(confirm('Delete?')) { await callAPI('DEL_DEPT', {id}); db.depts=db.depts.filter(d=>d.id!=id); renderDepts(); } }

        // EMPLOYEES
        function openEmpModal(emp=null) {
            document.getElementById('modal-emp').classList.remove('hidden');
            const s=document.getElementById('empDeptSelect'); s.innerHTML=''; db.depts.forEach(d=>s.innerHTML+=`<option value="${d.id}">${d.entity} - ${d.name}</option>`);
            
            // Set Default Toggle to Manual for Edit, or reset for New
            document.getElementById('codeToggle').checked = true; toggleCodeInput(); // Default Manual for safety

            if(emp) {
                document.getElementById('empModalTitle').innerText='Edit Profile'; document.getElementById('empId').value=emp.id; document.getElementById('empCode').value=emp.code; document.getElementById('empName').value=emp.personal.name; document.getElementById('empDeptSelect').value=emp.deptId; document.getElementById('empDesg').value=emp.personal.desg; document.getElementById('empDOJ').value=emp.personal.doj.split('T')[0]; document.getElementById('empBank').value=emp.bank.name; document.getElementById('empAC').value=emp.bank.ac; document.getElementById('empIFSC').value=emp.bank.ifsc; document.getElementById('salBasic').value=emp.salary.basic; document.getElementById('salDA').value=emp.salary.da; document.getElementById('salPF').value=emp.salary.epf; 
            } else { document.getElementById('empForm').reset(); document.getElementById('empModalTitle').innerText='Add Employee'; document.getElementById('empId').value=''; }
        }

        document.getElementById('empForm').onsubmit = async (e) => {
            e.preventDefault(); const idVal=document.getElementById('empId').value;
            let finalCode = document.getElementById('empCode').value;
            if(!document.getElementById('codeToggle').checked) {
                finalCode = 'EMP' + Math.floor(1000 + Math.random() * 9000); // Auto Generate
            }

            const emp = { id: idVal?idVal:Date.now(), deptId:document.getElementById('empDeptSelect').value, code:finalCode, personal: { name:document.getElementById('empName').value, desg:document.getElementById('empDesg').value, doj:document.getElementById('empDOJ').value, status:document.getElementById('empStatus').value, aadhaar:document.getElementById('empAadhaar').value, pan:document.getElementById('empPAN').value, uan:document.getElementById('empUAN').value }, bank: { name:document.getElementById('empBank').value, ac:document.getElementById('empAC').value, ifsc:document.getElementById('empIFSC').value, esi:document.getElementById('empESI').value }, salary: { basic:document.getElementById('salBasic').value, da:document.getElementById('salDA').value, ta:document.getElementById('salTA').value, hra:document.getElementById('salHRA').value, other:document.getElementById('salOther').value, epf:document.getElementById('salPF').value, esi_fixed:document.getElementById('salESIFix').value } };
            await callAPI('ADD_EMP', emp); if(idVal){const i=db.emps.findIndex(x=>x.id==idVal); if(i!==-1)db.emps[i]=emp;} else db.emps.push(emp);
            document.getElementById('modal-emp').classList.add('hidden'); renderEmps();
        };
        function renderEmps() { const tb=document.getElementById('empTableBody'); tb.innerHTML=''; db.emps.forEach(e=>{ const d=db.depts.find(x=>x.id==e.deptId)||{entity:'-',name:'-'}; tb.innerHTML+=`<tr class="border-b hover:bg-gray-50"><td class="p-4 font-mono text-blue-600 font-bold">${e.code}</td><td class="p-4 font-bold">${e.personal.name}<div class="text-xs text-gray-400 font-normal">${e.personal.desg}</div></td><td class="p-4 text-sm">${d.entity}<br>${d.name}</td><td class="p-4 text-right"><button onclick='openEmpModal(${JSON.stringify(e)})' class="text-blue-500 mr-3"><i class="fa-solid fa-pen"></i></button><button onclick="delEmp(${e.id})" class="text-red-500"><i class="fa-solid fa-trash"></i></button></td></tr>`; }); }
        async function delEmp(id) { if(confirm('Delete?')) { await callAPI('DEL_EMP', {id}); db.emps=db.emps.filter(e=>e.id!=id); renderEmps(); } }

        // PAYSLIP
        function fillEmpSelect() { const s=document.getElementById('psEmpSelect'); s.innerHTML='<option>-- Select --</option>'; db.emps.forEach(e=>s.innerHTML+=`<option value="${e.id}">${e.personal.name} (${e.code})</option>`); }
        function autoFetchEmp() { const id=document.getElementById('psEmpSelect').value; const e=db.emps.find(x=>x.id==id); if(e){ const d=db.depts.find(x=>x.id==e.deptId); document.getElementById('psDisplayInfo').value=`${e.personal.name} | ${e.personal.desg}`; document.getElementById('fixBasic').value=e.salary.basic; document.getElementById('fixDA').value=e.salary.da; document.getElementById('fixTA').value=e.salary.ta; document.getElementById('fixHRA').value=e.salary.hra; document.getElementById('fixOther').value=e.salary.other; document.getElementById('fixEPF').value=e.salary.epf; document.getElementById('fixESI').value=e.salary.esi_fixed; } }

        async function generatePDF() {
            const id = document.getElementById('psEmpSelect').value; if(!id || id.includes('Select')) return alert('Select Employee');
            const emp=db.emps.find(e=>e.id==id), dept=db.depts.find(d=>d.id==emp.deptId), m=document.getElementById('psMonth').value, y=document.getElementById('psYear').value;
            // Calc
            const basic=Number(document.getElementById('fixBasic').value), da=Number(document.getElementById('fixDA').value), ta=Number(document.getElementById('fixTA').value), hra=Number(document.getElementById('fixHRA').value), other=Number(document.getElementById('fixOther').value); const gross=basic+da+ta+hra+other;
            const epf=Number(document.getElementById('fixEPF').value), mut=Number(document.getElementById('psDedMUT').value), food=Number(document.getElementById('psDedFood').value), tax=Number(document.getElementById('psDedTax').value), esi=Number(document.getElementById('fixESI').value), welfare=Number(document.getElementById('psDedWelfare').value), adv=Number(document.getElementById('psDedAdv').value), lop=Number(document.getElementById('psDedLOP').value); const totalDed=epf+mut+food+tax+esi+welfare+adv+lop; const netPay=gross-totalDed;
            // PDF
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            doc.setFont("times", "bold"); doc.setFontSize(22); doc.text(dept.entity, 105, 15, null, null, "center");
            doc.setFont("times", "normal"); doc.setFontSize(10); doc.text(dept.address||"Head Office", 105, 20, null, null, "center");
            doc.setFont("times", "bold"); doc.setFontSize(14); doc.text(`Payslip: ${m}-${y}`, 105, 28, null, null, "center"); doc.line(10, 30, 200, 30);
            
            // Employee Profile Section
            doc.setFontSize(11); doc.setFont("times", "bold italic"); doc.text("Employee Profile:", 10, 38);
            const col1 = 10, col2 = 105; let Y = 45; const gap = 6;
            doc.setFont("times", "bold"); doc.text("Employee Name:", col1, Y); doc.setFont("times", "normal"); doc.text(emp.personal.name, col1+35, Y);
            doc.setFont("times", "bold"); doc.text("Designation:", col2, Y); doc.setFont("times", "normal"); doc.text(emp.personal.desg, col2+35, Y); Y+=gap;
            doc.setFont("times", "bold"); doc.text("Entity Name:", col1, Y); doc.setFont("times", "normal"); doc.text(dept.entity, col1+35, Y);
            doc.setFont("times", "bold"); doc.text("Department:", col2, Y); doc.setFont("times", "normal"); doc.text(dept.name, col2+35, Y); Y+=gap;
            doc.setFont("times", "bold"); doc.text("Emp Status:", col1, Y); doc.setFont("times", "normal"); doc.text(emp.personal.status, col1+35, Y);
            doc.setFont("times", "bold"); doc.text("Date Of Joining:", col2, Y); doc.setFont("times", "normal"); doc.text(emp.personal.doj.split('T')[0], col2+35, Y); Y+=gap;
            doc.setFont("times", "bold"); doc.text("Bank Name:", col1, Y); doc.setFont("times", "normal"); doc.text(emp.bank.name, col1+35, Y);
            doc.setFont("times", "bold"); doc.text("Aadhaar No:", col2, Y); doc.setFont("times", "normal"); doc.text(emp.personal.aadhaar, col2+35, Y); Y+=gap;
            doc.setFont("times", "bold"); doc.text("Branch:", col1, Y); doc.setFont("times", "normal"); doc.text(emp.bank.branch||'', col1+35, Y);
            doc.setFont("times", "bold"); doc.text("ESI Number:", col2, Y); doc.setFont("times", "normal"); doc.text(emp.bank.esi, col2+35, Y); Y+=gap;
            doc.setFont("times", "bold"); doc.text("A/c Number:", col1, Y); doc.setFont("times", "normal"); doc.text(String(emp.bank.ac), col1+35, Y);
            doc.setFont("times", "bold"); doc.text("UAN:", col2, Y); doc.setFont("times", "normal"); doc.text(emp.personal.uan, col2+35, Y); Y+=gap;
            doc.setFont("times", "bold"); doc.text("IFSC:", col1, Y); doc.setFont("times", "normal"); doc.text(emp.bank.ifsc, col1+35, Y);
            doc.setFont("times", "bold"); doc.text("MUT:", col2, Y); doc.setFont("times", "normal"); doc.text(String(mut), col2+35, y=Y); Y+=gap+5;

            // Leave Section
            doc.setFont("times", "bold italic"); doc.text("Leave Summary and Attendance Record:", 10, Y); Y+=5;
            doc.setFont("times", "bold");
            doc.text("Casual Leave:", col1, Y); doc.setFont("times", "italic"); doc.text(document.getElementById('psCL').value, col1+30, Y);
            doc.setFont("times", "bold"); doc.text("Present Days:", col2, Y); doc.setFont("times", "italic"); doc.text(document.getElementById('psPresent').value, col2+30, Y); Y+=gap;
            doc.setFont("times", "bold"); doc.text("Sick Leave:", col1, Y); doc.setFont("times", "italic"); doc.text(document.getElementById('psSL').value, col1+30, Y);
            doc.setFont("times", "bold"); doc.text("Absent:", col2, Y); doc.setFont("times", "italic"); doc.text(document.getElementById('psAbsent').value, col2+30, Y); Y+=gap;
            doc.setFont("times", "bold"); doc.text("Annual Leave:", col1, Y); doc.setFont("times", "italic"); doc.text(document.getElementById('psAL').value, col1+30, Y);
            doc.setFont("times", "bold"); doc.text("No.of Pay Days:", col2, Y); doc.setFont("times", "italic"); doc.text(document.getElementById('psPayDays').value, col2+30, Y); Y+=gap+5;

            doc.autoTable({ startY: Y, head: [['Earnings', 'Amount', 'Deductions', 'Amount']], body: [['Basic', basic, 'EPF', epf], ['DA', da, 'MUT', mut], ['TA', ta, 'Food', food], ['HRA', hra, 'Tax', tax], ['Other', other, 'ESI', esi], ['', '', 'Welfare', welfare], ['', '', 'Loan', adv], ['', '', 'LOP', lop]], theme: 'grid' });
            
            let fy = doc.lastAutoTable.finalY; doc.setLineWidth(0.2); doc.rect(14, fy, 182, 9);
            doc.setFont("times", "bold"); doc.text("Gross Earnings", 16, fy + 6); doc.text(gross.toFixed(2)+"/-", 60, fy + 6);
            doc.line(105, fy, 105, fy + 9); doc.text("Total Deductions", 107, fy + 6); doc.text(totalDed.toFixed(2)+"/-", 155, fy + 6);
            doc.setFontSize(12); doc.text(`NET PAY : Rs. ${netPay.toFixed(2)}/-`, 105, fy + 20, null, null, "center");
            
            doc.save(`Payslip_${emp.personal.name}.pdf`);
            await callAPI('SAVE_PAYSLIP', {month:m, year:y, empName:emp.personal.name, empCode:emp.code, netPay:netPay, user:currentUser.name});
        }

        async function loadHistory() {
            const res = await callAPI('GET_HISTORY');
            const tb = document.getElementById('historyTableBody'); tb.innerHTML = '';
            if(res.status=='success' && res.history) {
                res.history.forEach(h => { tb.innerHTML += `<tr class="border-b"><td class="p-4 text-gray-500">${new Date(h[0]).toLocaleDateString()}</td><td class="p-4 font-bold">${h[1]}-${h[2]}</td><td class="p-4">${h[3]}<br><small class="text-gray-400">${h[4]}</small></td><td class="p-4 text-green-600 font-bold">â‚¹${h[5]}</td><td class="p-4 text-right text-xs text-gray-400">${h[6]}</td></tr>`; });
            }
        }
    </script>
</body>
</html>