<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud HRMS Professional</title>
    
    <!-- PDF Engines -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --primary: #0f172a; /* Dark Navy */
            --accent: #2563eb; /* Blue */
            --bg: #f1f5f9;
            --white: #ffffff;
            --border: #cbd5e1;
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Loader */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Helpers */
        .hidden { display: none !important; }
        .btn { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; background: var(--accent); color: white; transition: 0.2s; font-size: 0.95rem; }
        .btn:hover { background: #1d4ed8; }
        .btn-danger { background: #ef4444; }
        
        .card { background: var(--white); padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; color: #475569; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; box-sizing: border-box; }

        /* Layout */
        .auth-container { display: flex; justify-content: center; align-items: center; height: 100vh; }
        .auth-box { width: 400px; text-align: center; }

        .dashboard { display: flex; height: 100vh; }
        .sidebar { width: 260px; background: var(--primary); color: white; display: flex; flex-direction: column; }
        .brand { padding: 20px; font-size: 1.4rem; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .nav-item { padding: 15px 20px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05); transition: 0.2s; }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.15); border-left: 4px solid var(--accent); }
        
        .content { flex: 1; padding: 30px; overflow-y: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; border-radius: 8px; overflow: hidden; }
        th { background: #e2e8f0; padding: 15px; text-align: left; font-weight: 600; }
        td { padding: 12px 15px; border-bottom: 1px solid #e2e8f0; }
        tr:hover { background: #f8fafc; }
    </style>
</head>
<body>

    <!-- LOADER -->
    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top: 15px; color: #475569;">Syncing with Google Database...</p>
    </div>

    <!-- 1. SETUP SCREEN -->
    <div id="view-setup" class="auth-container hidden">
        <div class="card auth-box">
            <h2 style="color: var(--primary);">Setup Organization</h2>
            <p style="margin-bottom: 20px; color: #64748b;">Initialize your database in Google Sheets</p>
            <form id="setupForm">
                <div class="form-group" style="text-align: left;"><label>Organization Name</label><input id="setupOrgName" required></div>
                <div class="form-group" style="text-align: left;"><label>Full Address</label><input id="setupAddress" required></div>
                <div class="form-group" style="text-align: left;"><label>Admin Email</label><input type="email" id="setupEmail" required></div>
                <div class="form-group" style="text-align: left;"><label>Password</label><input type="password" id="setupPassword" required></div>
                <button type="submit" class="btn" style="width: 100%;">Create Database</button>
            </form>
        </div>
    </div>

    <!-- 2. LOGIN SCREEN -->
    <div id="view-login" class="auth-container hidden">
        <div class="card auth-box">
            <h2 id="loginTitle" style="color: var(--primary);">Admin Login</h2>
            <form id="loginForm">
                <div class="form-group" style="text-align: left;"><label>Email</label><input type="email" id="loginEmail" required></div>
                <div class="form-group" style="text-align: left;"><label>Password</label><input type="password" id="loginPassword" required></div>
                <button type="submit" class="btn" style="width: 100%;">Login</button>
            </form>
        </div>
    </div>

    <!-- 3. DASHBOARD -->
    <div id="view-dashboard" class="dashboard hidden">
        <div class="sidebar">
            <div class="brand">HRMS Cloud</div>
            <div class="nav-item active" onclick="switchTab('tab-home')">üìä Overview</div>
            <div class="nav-item" onclick="switchTab('tab-depts')">üè¢ Entity & Depts</div>
            <div class="nav-item" onclick="switchTab('tab-employees')">üë• Employees</div>
            <div class="nav-item" onclick="switchTab('tab-payslip')">üßæ Generate Payslip</div>
            <div style="flex: 1;"></div>
            <div class="nav-item" onclick="location.reload()" style="background: #ef4444; text-align: center; border:none;">Logout</div>
        </div>

        <div class="content">
            
            <!-- HOME TAB -->
            <div id="tab-home">
                <div class="header">
                    <h2>Dashboard Overview</h2>
                    <span style="color: green; font-weight: bold;">‚óè Online</span>
                </div>
                <div class="grid-3">
                    <div class="card"><h3>Total Staff</h3><h1 id="statEmp" style="color:var(--accent)">0</h1></div>
                    <div class="card"><h3>Departments</h3><h1 id="statDept">0</h1></div>
                    <div class="card"><h3>Storage</h3><p>Google Drive Protected</p></div>
                </div>
            </div>

            <!-- DEPTS TAB -->
            <div id="tab-depts" class="hidden">
                <div class="header"><h2>Entity & Departments</h2></div>
                <div class="grid-2">
                    <div class="card">
                        <h3>Add New</h3>
                        <form id="deptForm">
                            <div class="form-group"><label>Entity (e.g. NIDS)</label><input id="newEntity" required placeholder="Organization Entity"></div>
                            <div class="form-group"><label>Department Name</label><input id="newDept" required placeholder="e.g. Admin, Nursing"></div>
                            <button class="btn">Add Record</button>
                        </form>
                    </div>
                    <div class="card">
                        <h3>Active List</h3>
                        <table id="deptTable">
                            <thead><tr><th>Entity</th><th>Department</th><th>Action</th></tr></thead>
                            <tbody id="deptTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- EMPLOYEE TAB -->
            <div id="tab-employees" class="hidden">
                <div class="header">
                    <h2>Employee Directory</h2>
                    <button class="btn" onclick="toggleModal('modal-emp')">+ Add Employee</button>
                </div>
                <div class="card">
                    <table id="empTable">
                        <thead><tr><th>Code</th><th>Name</th><th>Entity / Dept</th><th>Action</th></tr></thead>
                        <tbody id="empTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- PAYSLIP TAB -->
            <div id="tab-payslip" class="hidden">
                <div class="header"><h2>Payslip Generation</h2></div>
                <div class="card" style="max-width: 800px; margin: 0 auto;">
                    
                    <div style="background: #eff6ff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #dbeafe;">
                        <h4 style="margin-top:0; color: #1e40af;">1. Select Employee</h4>
                        <select id="psEmpSelect" onchange="autoFetchEmp()" style="background: white;"></select>
                        <p id="psAutoInfo" style="margin-top: 10px; font-weight: bold; color: #2563eb; font-size: 0.9rem;"></p>
                    </div>

                    <div class="grid-3">
                        <div class="form-group"><label>Month</label><select id="psMonth"><option>January</option><option>February</option><option>March</option><option>April</option><option>May</option><option>June</option><option>July</option><option>August</option><option>September</option><option>October</option><option>November</option><option>December</option></select></div>
                        <div class="form-group"><label>Year</label><select id="psYear"></select></div>
                        <div class="form-group"><label>Total Days</label><input type="number" id="psTotalDays" value="30"></div>
                    </div>

                    <div class="grid-2">
                        <div class="form-group"><label>Present Days</label><input type="number" id="psPresent" value="30"></div>
                        <div class="form-group"><label>Absent/LOP</label><input type="number" id="psLOP" value="0"></div>
                        <div class="form-group"><label>Food Deduction</label><input type="number" id="psDedFood" value="0"></div>
                        <div class="form-group"><label>Advance/Loan</label><input type="number" id="psDedAdv" value="0"></div>
                    </div>

                    <!-- Hidden Data -->
                    <input type="hidden" id="fixBasic"><input type="hidden" id="fixDA"><input type="hidden" id="fixHRA"><input type="hidden" id="fixOther"><input type="hidden" id="fixPF">

                    <button class="btn" onclick="generatePDF()" style="width: 100%; margin-top: 20px; font-size: 1.1rem;">Generate & Save to Cloud</button>
                </div>
            </div>

        </div>
    </div>

    <!-- MODAL: ADD EMPLOYEE -->
    <div id="modal-emp" class="hidden" style="position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:flex; justify-content:center; align-items:center; z-index: 1000;">
        <div class="card" style="width: 750px; max-height: 90vh; overflow-y: auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                <h3>Add New Employee</h3>
                <button onclick="toggleModal('modal-emp')" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            <form id="empForm">
                <h4 style="border-bottom:1px solid #ddd; margin-bottom:10px;">Personal</h4>
                <div class="grid-2">
                    <div class="form-group"><label>Full Name</label><input id="empName" required></div>
                    <div class="form-group"><label>Department</label><select id="empDeptSelect" required></select></div>
                    <div class="form-group"><label>Designation</label><input id="empDesg" required></div>
                    <div class="form-group"><label>Date Of Joining</label><input type="date" id="empDOJ" required></div>
                    <div class="form-group"><label>Aadhaar No</label><input id="empAadhaar"></div>
                    <div class="form-group"><label>PAN No</label><input id="empPAN"></div>
                </div>

                <h4 style="border-bottom:1px solid #ddd; margin-bottom:10px; margin-top:15px;">Bank & Statutory</h4>
                <div class="grid-3">
                    <div class="form-group"><label>Bank Name</label><input id="empBank"></div>
                    <div class="form-group"><label>AC No</label><input id="empAC"></div>
                    <div class="form-group"><label>IFSC</label><input id="empIFSC"></div>
                    <div class="form-group"><label>ESI No</label><input id="empESI"></div>
                </div>

                <h4 style="border-bottom:1px solid #ddd; margin-bottom:10px; margin-top:15px;">Salary Structure</h4>
                <div class="grid-3">
                    <div class="form-group"><label>Basic</label><input type="number" id="salBasic" value="0"></div>
                    <div class="form-group"><label>DA</label><input type="number" id="salDA" value="0"></div>
                    <div class="form-group"><label>HRA</label><input type="number" id="salHRA" value="0"></div>
                    <div class="form-group"><label>Others</label><input type="number" id="salOther" value="0"></div>
                    <div class="form-group"><label>PF Ded.</label><input type="number" id="salPF" value="0"></div>
                </div>

                <div style="text-align: right; margin-top: 20px;">
                    <button type="submit" class="btn">Save to Google Sheet</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ============================================== -->
    <!-- JAVASCRIPT LOGIC -->
    <!-- ============================================== -->
    <script>
        // -------------------------------------------------------------
        // YOUR INTEGRATED WEB APP URL (Ready to use)
        // -------------------------------------------------------------
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxIhLXnTrKnPixJM4g8L8t_QVuOrFYMzVlIX1pvODtZZ5egx7NQEQ0ciFQa5gYd3JwQ/exec"; 
        
        let db = { org: null, departments: [], employees: [] };

        // --- API CALL FUNCTION ---
        async function callAPI(action, payload = {}) {
            document.getElementById('loader').classList.remove('hidden');
            try {
                // Sending as text/plain to avoid CORS preflight, backend parses the JSON string
                const response = await fetch(SCRIPT_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: action, ...payload })
                });
                const result = await response.json();
                document.getElementById('loader').classList.add('hidden');
                return result;
            } catch (e) {
                document.getElementById('loader').classList.add('hidden');
                console.error(e);
                alert("Network Error! Please check your internet connection.");
                return { status: 'error' };
            }
        }

        // --- INIT ---
        window.onload = async () => {
            // Fill Years 2020-2060
            const ySel = document.getElementById('psYear');
            for(let y=2020; y<=2060; y++) {
                let opt = document.createElement('option');
                opt.value=y; opt.innerText=y;
                if(y===new Date().getFullYear()) opt.selected=true;
                ySel.appendChild(opt);
            }

            // Fetch All Data on Load
            const res = await callAPI('GET_ALL_DATA');
            if(res.status === 'success') {
                const data = res.data;
                db.departments = data.departments || [];
                db.employees = data.employees || [];

                if(data.org) {
                    db.org = data.org;
                    showView('view-login');
                    document.getElementById('loginTitle').innerText = db.org.name;
                } else {
                    showView('view-setup');
                }
            }
        };

        // --- VIEWS ---
        function showView(id) {
            document.querySelectorAll('.auth-container, .dashboard').forEach(e => e.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }
        function switchTab(id) {
            document.querySelectorAll('[id^="tab-"]').forEach(e => e.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            event.target.classList.add('active');

            if(id === 'tab-employees') renderEmpTable();
            if(id === 'tab-payslip') fillEmpSelect();
        }
        function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); }

        // --- ACTIONS ---
        document.getElementById('setupForm').onsubmit = async (e) => {
            e.preventDefault();
            const payload = {
                name: document.getElementById('setupOrgName').value,
                address: document.getElementById('setupAddress').value,
                email: document.getElementById('setupEmail').value,
                password: document.getElementById('setupPassword').value
            };
            const res = await callAPI('SETUP_ORG', payload);
            if(res.status === 'success') location.reload();
        };

        document.getElementById('loginForm').onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            // Validate via Cloud
            const res = await callAPI('LOGIN', { email, password });
            if(res.status === 'success') {
                showView('view-dashboard');
                updateStats();
            } else alert(res.msg);
        };

        // --- DEPARTMENTS ---
        document.getElementById('deptForm').onsubmit = async (e) => {
            e.preventDefault();
            const payload = {
                id: Date.now(),
                entity: document.getElementById('newEntity').value,
                name: document.getElementById('newDept').value
            };
            await callAPI('ADD_DEPT', payload);
            db.departments.push(payload);
            updateStats();
            renderDepts();
            e.target.reset();
        };

        function renderDepts() {
            const tb = document.getElementById('deptTableBody'); tb.innerHTML = '';
            db.departments.forEach(d => {
                tb.innerHTML += `<tr><td>${d.entity}</td><td>${d.name}</td><td><button class="btn btn-danger" style="padding:5px 10px;" onclick="delDept(${d.id})">X</button></td></tr>`;
            });
        }
        async function delDept(id) {
            if(!confirm('Delete?')) return;
            await callAPI('DEL_DEPT', {id});
            db.departments = db.departments.filter(d => d.id !== id);
            renderDepts(); updateStats();
        }

        // --- EMPLOYEES ---
        document.getElementById('empForm').onsubmit = async (e) => {
            e.preventDefault();
            const emp = {
                id: Date.now(),
                deptId: document.getElementById('empDeptSelect').value,
                code: 'EMP' + Math.floor(1000 + Math.random() * 9000),
                personal: {
                    name: document.getElementById('empName').value,
                    desg: document.getElementById('empDesg').value,
                    doj: document.getElementById('empDOJ').value,
                    status: 'Active',
                    aadhaar: document.getElementById('empAadhaar').value,
                    pan: document.getElementById('empPAN').value,
                    uan: ''
                },
                bank: {
                    name: document.getElementById('empBank').value,
                    branch: '',
                    ac: document.getElementById('empAC').value,
                    ifsc: document.getElementById('empIFSC').value,
                    esi: document.getElementById('empESI').value,
                    mut: ''
                },
                salary: {
                    basic: document.getElementById('salBasic').value,
                    da: document.getElementById('salDA').value,
                    hra: document.getElementById('salHRA').value,
                    ta: 0,
                    other: document.getElementById('salOther').value,
                    epf: document.getElementById('salPF').value
                }
            };
            await callAPI('ADD_EMP', emp);
            db.employees.push(emp);
            toggleModal('modal-emp');
            renderEmpTable();
            updateStats();
        };

        function renderEmpTable() {
            const tb = document.getElementById('empTableBody'); tb.innerHTML = '';
            
            // Populate Dept Select for Modal
            const ds = document.getElementById('empDeptSelect'); ds.innerHTML = '';
            db.departments.forEach(d => ds.innerHTML += `<option value="${d.id}">${d.entity} - ${d.name}</option>`);

            db.employees.forEach(e => {
                const d = db.departments.find(dp => dp.id == e.deptId) || {entity:'-', name:'-'};
                tb.innerHTML += `<tr><td>${e.code}</td><td><b>${e.personal.name}</b></td><td>${d.entity} / ${d.name}</td><td><button class="btn btn-danger" style="padding:5px;" onclick="delEmp(${e.id})">Del</button></td></tr>`;
            });
        }
        async function delEmp(id) {
            if(!confirm('Delete Employee?')) return;
            await callAPI('DEL_EMP', {id});
            db.employees = db.employees.filter(e => e.id !== id);
            renderEmpTable(); updateStats();
        }

        // --- PAYSLIP ---
        function fillEmpSelect() {
            const s = document.getElementById('psEmpSelect');
            s.innerHTML = '<option value="">-- Select Employee --</option>';
            db.employees.forEach(e => s.innerHTML += `<option value="${e.id}">${e.personal.name} (${e.code})</option>`);
        }

        function autoFetchEmp() {
            const id = document.getElementById('psEmpSelect').value;
            if(!id) return;
            const emp = db.employees.find(e => e.id == id);
            const dept = db.departments.find(d => d.id == emp.deptId);
            
            document.getElementById('psAutoInfo').innerText = `Fetched: ${emp.personal.desg} at ${dept.entity}`;
            
            // Hidden Fix
            document.getElementById('fixBasic').value = emp.salary.basic;
            document.getElementById('fixDA').value = emp.salary.da;
            document.getElementById('fixHRA').value = emp.salary.hra;
            document.getElementById('fixOther').value = emp.salary.other;
            document.getElementById('fixPF').value = emp.salary.epf;
        }

        async function generatePDF() {
            const id = document.getElementById('psEmpSelect').value;
            if(!id) return alert("Select Employee!");

            const emp = db.employees.find(e => e.id == id);
            const dept = db.departments.find(d => d.id == emp.deptId);
            const month = document.getElementById('psMonth').value;
            const year = document.getElementById('psYear').value;

            // Calculations
            const basic = parseFloat(document.getElementById('fixBasic').value) || 0;
            const da = parseFloat(document.getElementById('fixDA').value) || 0;
            const hra = parseFloat(document.getElementById('fixHRA').value) || 0;
            const other = parseFloat(document.getElementById('fixOther').value) || 0;
            const pf = parseFloat(document.getElementById('fixPF').value) || 0;
            
            const dedFood = parseFloat(document.getElementById('psDedFood').value) || 0;
            const dedAdv = parseFloat(document.getElementById('psDedAdv').value) || 0;
            
            const gross = basic + da + hra + other;
            const totalDed = pf + dedFood + dedAdv;
            const netPay = gross - totalDed;

            // PDF Generation
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Header (Entity Focused - Letterhead Style)
            doc.setFontSize(22); doc.setFont("helvetica", "bold");
            doc.text(dept.entity.toUpperCase(), 105, 18, null, null, "center"); // Entity Name (e.g., NIDS)
            
            doc.setFontSize(10); doc.setFont("helvetica", "normal");
            doc.text(db.org.address, 105, 25, null, null, "center"); // Org Address
            doc.setLineWidth(0.5);
            doc.line(10, 28, 200, 28);

            doc.setFontSize(14); doc.setFont("helvetica", "bold");
            doc.text(`PAYSLIP: ${month.toUpperCase()} ${year}`, 105, 38, null, null, "center");

            // Employee Profile Table
            doc.autoTable({
                startY: 42,
                theme: 'plain',
                styles: { fontSize: 10, cellPadding: 2 },
                columnStyles: { 0: { fontStyle: 'bold', width: 40 }, 2: { fontStyle: 'bold', width: 40 } },
                body: [
                    ['Employee Name:', emp.personal.name, 'Designation:', emp.personal.desg],
                    ['Department:', dept.name, 'Date Of Joining:', emp.personal.doj],
                    ['Bank Name:', emp.bank.name, 'Account No:', emp.bank.ac],
                    ['PAN No:', emp.personal.pan, 'UAN No:', emp.personal.uan]
                ]
            });

            // Earnings & Deductions Table
            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 10,
                head: [['Earnings', 'Amount (Rs)', 'Deductions', 'Amount (Rs)']],
                body: [
                    ['Basic Salary', basic.toFixed(2), 'Provident Fund', pf.toFixed(2)],
                    ['DA', da.toFixed(2), 'Food Deduction', dedFood.toFixed(2)],
                    ['HRA', hra.toFixed(2), 'Advance / Loan', dedAdv.toFixed(2)],
                    ['Other Allowances', other.toFixed(2), '', ''],
                ],
                foot: [['Gross Earnings', gross.toFixed(2), 'Total Deductions', totalDed.toFixed(2)]],
                theme: 'grid',
                headStyles: { fillColor: [15, 23, 42] }, // Dark Navy
                footStyles: { fillColor: [240, 240, 240], textColor: [0,0,0] }
            });

            // Net Pay Highlight
            doc.setFontSize(14); doc.setFont("helvetica", "bold");
            doc.text(`NET PAYABLE: Rs. ${netPay.toFixed(2)} /-`, 195, doc.lastAutoTable.finalY + 20, null, null, "right");
            
            // Signature Line
            doc.setLineWidth(0.1);
            doc.line(140, 270, 190, 270);
            doc.setFontSize(8); doc.setFont("helvetica", "normal");
            doc.text("Authorized Signature", 165, 275, null, null, "center");

            doc.save(`Payslip_${emp.personal.name}_${month}_${year}.pdf`);

            // Save to Cloud
            await callAPI('SAVE_PAYSLIP', {
                month: month, year: year,
                empName: emp.personal.name, empCode: emp.code,
                department: dept.name, entity: dept.entity,
                netPay: netPay
            });
            alert("Payslip Generated & Saved to Cloud Database!");
        }

        function updateStats() {
            document.getElementById('statEmp').innerText = db.employees.length;
            document.getElementById('statDept').innerText = db.departments.length;
            renderDepts();
        }
    </script>
</body>
</html>
