<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise HRMS AI</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: 'var(--color-primary)',
                        secondary: 'var(--color-secondary)',
                    }
                }
            }
        }
    </script>
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- PDF Libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* Dynamic Themes */
        :root { --color-primary: #1e40af; --color-secondary: #1e293b; } /* Navy (Default) */
        .theme-teal { --color-primary: #0d9488; --color-secondary: #134e4a; }
        .theme-dark { --color-primary: #6366f1; --color-secondary: #0f172a; }
        
        /* Apply Theme Colors */
        .bg-theme-primary { background-color: var(--color-primary); }
        .bg-theme-secondary { background-color: var(--color-secondary); }
        .text-theme-primary { color: var(--color-primary); }
        
        /* Transitions */
        .transition-width { transition: width 0.3s ease-in-out; }
        
        /* Loader */
        .loader-dots div { animation: loader-dots1 0.6s infinite; }
        .loader-dots div:nth-child(2) { animation-delay: 0.1s; }
        .loader-dots div:nth-child(3) { animation-delay: 0.2s; }
        .loader-dots div:nth-child(4) { animation-delay: 0.3s; }
        @keyframes loader-dots1 { 0% { transform: scale(0); } 100% { transform: scale(1); } }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800 selection:bg-blue-200">

    <!-- LOADER -->
    <div id="loader" class="fixed inset-0 bg-white/90 z-[9999] flex flex-col items-center justify-center backdrop-blur-sm">
        <div class="flex space-x-2 loader-dots">
            <div class="w-4 h-4 bg-theme-primary rounded-full"></div>
            <div class="w-4 h-4 bg-theme-primary rounded-full"></div>
            <div class="w-4 h-4 bg-theme-primary rounded-full"></div>
        </div>
        <p class="mt-4 text-gray-600 font-medium animate-pulse">Syncing with Secure Cloud...</p>
    </div>

    <!-- ================= AUTH SECTION ================= -->
    <div id="auth-wrapper" class="min-h-screen bg-theme-secondary flex items-center justify-center p-4 relative overflow-hidden">
        <!-- AI Decorative Background -->
        <div class="absolute inset-0 opacity-10 pointer-events-none">
            <div class="absolute top-10 left-10 w-32 h-32 bg-white rounded-full blur-3xl"></div>
            <div class="absolute bottom-10 right-10 w-64 h-64 bg-theme-primary rounded-full blur-3xl"></div>
        </div>

        <!-- SETUP (First Time) -->
        <div id="view-setup" class="hidden w-full max-w-md bg-white/95 backdrop-blur rounded-2xl shadow-2xl overflow-hidden border border-white/20">
            <div class="bg-theme-primary p-6 text-center text-white">
                <h1 class="text-2xl font-bold"><i class="fa-solid fa-rocket mr-2"></i> System Setup</h1>
                <p class="text-sm opacity-90">One-time configuration</p>
            </div>
            <form id="setupForm" class="p-8 space-y-4">
                <input id="setupOrg" placeholder="Organization Name" required class="w-full px-4 py-3 bg-gray-50 border rounded-lg focus:ring-2 focus:ring-theme-primary outline-none transition">
                <input id="setupAddr" placeholder="Head Office Address" required class="w-full px-4 py-3 bg-gray-50 border rounded-lg focus:ring-2 focus:ring-theme-primary outline-none transition">
                <input type="email" id="setupEmail" placeholder="Super Admin Email" required class="w-full px-4 py-3 bg-gray-50 border rounded-lg focus:ring-2 focus:ring-theme-primary outline-none transition">
                <input type="password" id="setupPass" placeholder="Secure Password" required class="w-full px-4 py-3 bg-gray-50 border rounded-lg focus:ring-2 focus:ring-theme-primary outline-none transition">
                <button class="w-full py-3 bg-theme-primary text-white rounded-lg font-bold hover:brightness-110 shadow-lg transition transform hover:-translate-y-1">Initialize Database</button>
            </form>
        </div>

        <!-- LOGIN -->
        <div id="view-login" class="hidden w-full max-w-sm bg-white/95 backdrop-blur rounded-2xl shadow-2xl overflow-hidden border border-white/20 transform transition-all hover:shadow-blue-500/20">
            <div class="p-8 pb-4 text-center">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-blue-50 mb-4 animate-bounce">
                    <i class="fa-solid fa-fingerprint text-3xl text-theme-primary"></i>
                </div>
                <h2 id="loginOrgName" class="text-2xl font-bold text-gray-800">Secure Login</h2>
                <p class="text-gray-500 text-sm">Access your HR Workspace</p>
            </div>
            <form id="loginForm" class="p-8 pt-4 space-y-5">
                <div class="relative group">
                    <i class="fa-solid fa-envelope absolute left-4 top-3.5 text-gray-400 group-focus-within:text-theme-primary transition"></i>
                    <input type="email" id="loginEmail" placeholder="Email Address" required class="pl-12 w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-theme-primary focus:border-transparent outline-none transition bg-gray-50 focus:bg-white">
                </div>
                <div class="relative group">
                    <i class="fa-solid fa-lock absolute left-4 top-3.5 text-gray-400 group-focus-within:text-theme-primary transition"></i>
                    <input type="password" id="loginPass" placeholder="Password" required class="pl-12 w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-theme-primary focus:border-transparent outline-none transition bg-gray-50 focus:bg-white">
                    <i class="fa-solid fa-eye absolute right-4 top-3.5 text-gray-400 cursor-pointer hover:text-theme-primary transition" onclick="togglePass()"></i>
                </div>
                <button class="w-full py-3.5 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl font-bold shadow-lg hover:shadow-xl transition transform hover:-translate-y-0.5">
                    Sign In <i class="fa-solid fa-arrow-right ml-2"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- ================= DASHBOARD ================= -->
    <div id="view-dashboard" class="hidden flex h-screen overflow-hidden bg-gray-100">
        
        <!-- SIDEBAR -->
        <aside id="sidebar" class="w-64 bg-theme-secondary text-white flex flex-col shadow-2xl transition-width duration-300 relative z-20">
            <div class="p-6 border-b border-white/10 flex items-center gap-3 overflow-hidden whitespace-nowrap">
                <i class="fa-brands fa-hive text-2xl text-blue-400"></i>
                <span class="text-lg font-bold tracking-wide sidebar-text">HRMS Pro</span>
            </div>

            <nav class="flex-1 py-6 px-3 space-y-2 overflow-y-auto no-scrollbar">
                <a onclick="navTo('tab-home')" id="nav-home" class="nav-item flex items-center px-4 py-3 rounded-xl cursor-pointer bg-white/10 text-white shadow-inner border border-white/5 transition-all hover:bg-white/20">
                    <i class="fa-solid fa-chart-pie w-6 text-center"></i> <span class="ml-3 sidebar-text font-medium">Dashboard</span>
                </a>
                <a onclick="navTo('tab-users')" id="nav-users" class="nav-item flex items-center px-4 py-3 rounded-xl cursor-pointer text-slate-400 hover:text-white hover:bg-white/10 transition-all">
                    <i class="fa-solid fa-users-gear w-6 text-center"></i> <span class="ml-3 sidebar-text">Admin Console</span>
                </a>
                <a onclick="navTo('tab-depts')" id="nav-depts" class="nav-item flex items-center px-4 py-3 rounded-xl cursor-pointer text-slate-400 hover:text-white hover:bg-white/10 transition-all">
                    <i class="fa-solid fa-building w-6 text-center"></i> <span class="ml-3 sidebar-text">Departments</span>
                </a>
                <a onclick="navTo('tab-emp')" id="nav-emp" class="nav-item flex items-center px-4 py-3 rounded-xl cursor-pointer text-slate-400 hover:text-white hover:bg-white/10 transition-all">
                    <i class="fa-solid fa-users w-6 text-center"></i> <span class="ml-3 sidebar-text">Employees</span>
                </a>
                <a onclick="navTo('tab-pay')" id="nav-pay" class="nav-item flex items-center px-4 py-3 rounded-xl cursor-pointer text-slate-400 hover:text-white hover:bg-white/10 transition-all">
                    <i class="fa-solid fa-wand-magic-sparkles w-6 text-center"></i> <span class="ml-3 sidebar-text">Payslip Gen</span>
                </a>
                <a onclick="navTo('tab-history')" id="nav-history" class="nav-item flex items-center px-4 py-3 rounded-xl cursor-pointer text-slate-400 hover:text-white hover:bg-white/10 transition-all">
                    <i class="fa-solid fa-clock-rotate-left w-6 text-center"></i> <span class="ml-3 sidebar-text">History</span>
                </a>
            </nav>

            <div class="p-4 border-t border-white/10">
                <button onclick="location.reload()" class="w-full flex items-center justify-center px-4 py-2 text-sm font-medium text-red-300 bg-white/5 rounded-lg hover:bg-red-600/20 hover:text-red-200 transition-all">
                    <i class="fa-solid fa-power-off"></i> <span class="ml-2 sidebar-text">Logout</span>
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <div class="flex-1 flex flex-col overflow-hidden relative">
            
            <!-- Header -->
            <header class="bg-white shadow-sm h-16 flex items-center justify-between px-6 z-10">
                <div class="flex items-center gap-4">
                    <button onclick="toggleSidebar()" class="text-gray-500 hover:text-theme-primary transition transform hover:scale-110">
                        <i class="fa-solid fa-bars text-xl"></i>
                    </button>
                    <h2 id="pageTitle" class="text-xl font-bold text-gray-800 hidden md:block">Overview</h2>
                </div>

                <div class="flex items-center gap-4">
                    <!-- Theme Selector -->
                    <div class="flex bg-gray-100 rounded-full p-1 border border-gray-200">
                        <button onclick="changeTheme('default')" class="w-6 h-6 rounded-full bg-blue-800 mx-1 shadow-sm hover:scale-110 transition" title="Navy"></button>
                        <button onclick="changeTheme('theme-teal')" class="w-6 h-6 rounded-full bg-teal-600 mx-1 shadow-sm hover:scale-110 transition" title="Teal"></button>
                        <button onclick="changeTheme('theme-dark')" class="w-6 h-6 rounded-full bg-indigo-600 mx-1 shadow-sm hover:scale-110 transition" title="Indigo"></button>
                    </div>

                    <div class="flex items-center gap-3 pl-4 border-l">
                        <div class="text-right hidden sm:block">
                            <p id="userDisplay" class="text-sm font-bold text-gray-900">User</p>
                            <span id="roleDisplay" class="text-xs px-2 py-0.5 rounded-full bg-blue-100 text-blue-800 font-bold">Role</span>
                        </div>
                        <div class="h-9 w-9 rounded-full bg-theme-primary text-white flex items-center justify-center shadow-lg">
                            <i class="fa-solid fa-user"></i>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Scroll Area -->
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-50 p-6 md:p-8">
                
                <!-- TAB: HOME (With AI Stats) -->
                <div id="tab-home" class="space-y-6">
                    <!-- AI Insight Card -->
                    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl p-6 text-white shadow-xl relative overflow-hidden">
                        <div class="absolute right-0 top-0 opacity-10 transform translate-x-10 -translate-y-10">
                            <i class="fa-solid fa-robot text-9xl"></i>
                        </div>
                        <h3 class="text-lg font-bold flex items-center gap-2"><i class="fa-solid fa-wand-magic-sparkles"></i> AI HR Analyst</h3>
                        <p id="aiInsightText" class="mt-2 text-indigo-100 text-sm max-w-2xl">
                            Analyzing your workforce data...
                        </p>
                    </div>

                    <!-- Stats Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition">
                            <div class="flex justify-between items-start">
                                <div><p class="text-xs text-gray-500 font-bold uppercase">Total Staff</p><h3 id="statEmp" class="text-3xl font-bold text-gray-800 mt-1">0</h3></div>
                                <div class="p-3 bg-blue-50 text-blue-600 rounded-xl"><i class="fa-solid fa-users text-xl"></i></div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition">
                            <div class="flex justify-between items-start">
                                <div><p class="text-xs text-gray-500 font-bold uppercase">Departments</p><h3 id="statDept" class="text-3xl font-bold text-gray-800 mt-1">0</h3></div>
                                <div class="p-3 bg-emerald-50 text-emerald-600 rounded-xl"><i class="fa-solid fa-building text-xl"></i></div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition">
                            <div class="flex justify-between items-start">
                                <div><p class="text-xs text-gray-500 font-bold uppercase">Cloud Status</p><h3 class="text-lg font-bold text-green-600 mt-1 flex items-center gap-2"><span class="relative flex h-3 w-3"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span></span> Connected</h3></div>
                                <div class="p-3 bg-orange-50 text-orange-600 rounded-xl"><i class="fa-solid fa-cloud text-xl"></i></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB: ADMIN CONSOLE -->
                <div id="tab-users" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm lg:col-span-1 border border-gray-100">
                        <h3 class="font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-user-plus text-theme-primary"></i> Create User</h3>
                        <form id="userForm" class="space-y-3">
                            <input id="newUserName" placeholder="Full Name" required class="w-full border rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-theme-primary outline-none">
                            <input type="email" id="newUserEmail" placeholder="Email" required class="w-full border rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-theme-primary outline-none">
                            <input type="password" id="newUserPass" placeholder="Password" required class="w-full border rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-theme-primary outline-none">
                            <select id="newUserRole" class="w-full border rounded-lg p-2.5 text-sm bg-white"><option value="HR">HR Manager</option><option value="MANAGER">Dept Head</option></select>
                            <div class="bg-gray-50 p-3 rounded-lg border text-sm space-y-2">
                                <p class="text-xs font-bold text-gray-500">ACCESS RIGHTS</p>
                                <label class="flex items-center gap-2"><input type="checkbox" id="perm_dept" class="rounded text-theme-primary"> Manage Depts</label>
                                <label class="flex items-center gap-2"><input type="checkbox" id="perm_emp" class="rounded text-theme-primary"> Manage Staff</label>
                                <label class="flex items-center gap-2"><input type="checkbox" id="perm_pay" class="rounded text-theme-primary"> Payroll Access</label>
                            </div>
                            <button class="w-full bg-theme-primary text-white py-2.5 rounded-lg font-bold hover:brightness-110 shadow-lg">Create Account</button>
                        </form>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm lg:col-span-2 border border-gray-100">
                        <table class="w-full text-left text-sm"><thead class="bg-gray-50 text-gray-500 font-bold uppercase"><tr><th class="p-3">User</th><th class="p-3">Role</th><th class="p-3 text-right">Action</th></tr></thead><tbody id="userTableBody"></tbody></table>
                    </div>
                </div>

                <!-- TAB: DEPARTMENTS -->
                <div id="tab-depts" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm lg:col-span-1 border border-gray-100">
                        <h3 class="font-bold mb-4">Add Department</h3>
                        <form id="deptForm" class="space-y-3">
                            <input id="newEntity" placeholder="Entity (e.g. NIDS)" required class="w-full border rounded-lg p-2.5 text-sm">
                            <input id="newDept" placeholder="Department Name" required class="w-full border rounded-lg p-2.5 text-sm">
                            <textarea id="newDeptAddr" placeholder="Address (For Header)" rows="2" class="w-full border rounded-lg p-2.5 text-sm"></textarea>
                            <button class="w-full bg-theme-primary text-white py-2.5 rounded-lg font-bold shadow-lg">Save Dept</button>
                        </form>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm lg:col-span-2 border border-gray-100">
                        <table class="w-full text-left text-sm"><thead class="bg-gray-50 text-gray-500 font-bold uppercase"><tr><th class="p-3">Entity</th><th class="p-3">Dept</th><th class="p-3 text-right">Act</th></tr></thead><tbody id="deptTableBody"></tbody></table>
                    </div>
                </div>

                <!-- TAB: EMPLOYEES -->
                <div id="tab-emp" class="hidden">
                    <div class="flex justify-between mb-4"><h3 class="text-xl font-bold">Staff Directory</h3><button onclick="openEmpModal()" class="bg-theme-primary text-white px-5 py-2.5 rounded-xl shadow-lg hover:brightness-110 flex items-center gap-2"><i class="fa-solid fa-plus"></i> Add Employee</button></div>
                    <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100">
                        <table class="w-full text-left text-sm"><thead class="bg-gray-50 text-gray-500 font-bold uppercase"><tr><th class="p-4">Code</th><th class="p-4">Name</th><th class="p-4">Dept</th><th class="p-4 text-right">Actions</th></tr></thead><tbody id="empTableBody" class="divide-y"></tbody></table>
                    </div>
                </div>

                <!-- TAB: PAYSLIP -->
                <div id="tab-pay" class="hidden">
                    <div class="max-w-5xl mx-auto bg-white rounded-2xl shadow-xl p-8 border border-gray-100">
                        <div class="flex items-center justify-between border-b pb-4 mb-6">
                            <h3 class="text-xl font-bold text-gray-800"><i class="fa-solid fa-file-invoice text-theme-primary mr-2"></i> Payroll Generator</h3>
                            <span class="text-xs bg-green-100 text-green-700 px-3 py-1 rounded-full font-bold">Secure Calculation</span>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div><label class="block text-xs font-bold text-gray-500 uppercase">Employee</label><select id="psEmpSelect" onchange="autoFetchEmp()" class="w-full border rounded-lg p-2.5 mt-1 bg-gray-50 focus:ring-2 focus:ring-theme-primary outline-none"><option>-- Search --</option></select></div>
                            <div><label class="block text-xs font-bold text-gray-500 uppercase">Selected Profile</label><input id="psDisplayInfo" readonly class="w-full border rounded-lg p-2.5 mt-1 bg-gray-100 text-gray-600"></div>
                        </div>

                        <div class="grid grid-cols-3 gap-4 mb-6">
                            <div><label class="text-xs font-bold text-gray-500">Month</label><select id="psMonth" class="w-full border rounded-lg p-2"><option>January</option><option>February</option><option>March</option><option>April</option><option>May</option><option>June</option><option>July</option><option>August</option><option>September</option><option>October</option><option>November</option><option>December</option></select></div>
                            <div><label class="text-xs font-bold text-gray-500">Year</label><select id="psYear" class="w-full border rounded-lg p-2"></select></div>
                            <div><label class="text-xs font-bold text-gray-500">Work Days</label><input type="number" id="psTotalDays" value="30" class="w-full border rounded-lg p-2"></div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-blue-50 p-5 rounded-xl border border-blue-100">
                                <h4 class="text-xs font-bold text-blue-800 uppercase mb-3 border-b border-blue-200 pb-1">Attendance & Leave</h4>
                                <div class="grid grid-cols-2 gap-3 text-sm">
                                    <div><label class="text-xs text-blue-600">CL</label><input type="number" id="psCL" value="0" class="w-full border rounded p-1"></div>
                                    <div><label class="text-xs text-blue-600">SL</label><input type="number" id="psSL" value="0" class="w-full border rounded p-1"></div>
                                    <div><label class="text-xs text-blue-600">AL</label><input type="number" id="psAL" value="0" class="w-full border rounded p-1"></div>
                                    <div><label class="text-xs text-blue-600">Absent</label><input type="number" id="psAbsent" value="0" class="w-full border rounded p-1"></div>
                                    <div class="col-span-2"><label class="text-xs text-blue-800 font-bold">Paid Days</label><input type="number" id="psPayDays" value="30" class="w-full border rounded p-1 font-bold"></div>
                                    <input type="hidden" id="psPresent" value="30">
                                </div>
                            </div>
                            <div class="bg-red-50 p-5 rounded-xl border border-red-100">
                                <h4 class="text-xs font-bold text-red-800 uppercase mb-3 border-b border-red-200 pb-1">Deductions (Monthly)</h4>
                                <div class="grid grid-cols-2 gap-3 text-sm">
                                    <div><label class="text-xs text-red-600">Food</label><input type="number" id="psDedFood" value="0" class="w-full border rounded p-1"></div>
                                    <div><label class="text-xs text-red-600">Loan/Adv</label><input type="number" id="psDedAdv" value="0" class="w-full border rounded p-1"></div>
                                    <div><label class="text-xs text-red-600">MUT/Other</label><input type="number" id="psDedMUT" value="0" class="w-full border rounded p-1"></div>
                                    <div><label class="text-xs text-red-600">Tax/TDS</label><input type="number" id="psDedTax" value="0" class="w-full border rounded p-1"></div>
                                    <div><label class="text-xs text-red-600">Welfare</label><input type="number" id="psDedWelfare" value="0" class="w-full border rounded p-1"></div>
                                    <div><label class="text-xs text-red-600">LOP Amt</label><input type="number" id="psDedLOP" value="0" class="w-full border rounded p-1"></div>
                                    <input type="hidden" id="psDedMed" value="0">
                                </div>
                            </div>
                        </div>
                        
                        <input type="hidden" id="fixBasic"><input type="hidden" id="fixDA"><input type="hidden" id="fixTA"><input type="hidden" id="fixHRA"><input type="hidden" id="fixOther"><input type="hidden" id="fixEPF"><input type="hidden" id="fixESI">

                        <button onclick="generatePDF()" class="w-full mt-6 bg-theme-secondary text-white py-4 rounded-xl font-bold shadow-lg hover:shadow-xl transition flex justify-center items-center gap-2 text-lg">
                            <i class="fa-solid fa-print"></i> Generate Official Payslip
                        </button>
                    </div>
                </div>

                <!-- TAB: HISTORY -->
                <div id="tab-history" class="hidden">
                    <h3 class="text-xl font-bold mb-4">Transaction History</h3>
                    <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100">
                        <table class="w-full text-left text-sm"><thead class="bg-gray-50 text-gray-500 font-bold uppercase"><tr><th class="p-4">Date</th><th class="p-4">Period</th><th class="p-4">Employee</th><th class="p-4">Net Pay</th><th class="p-4 text-right">User</th></tr></thead><tbody id="historyTableBody" class="divide-y"></tbody></table>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- MODAL: ADD EMPLOYEE -->
    <div id="modal-emp" class="hidden fixed inset-0 bg-black/60 z-[100] flex items-center justify-center backdrop-blur-md">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto m-4 animate-fade-in">
            <div class="flex justify-between items-center p-6 border-b sticky top-0 bg-white z-10">
                <h3 id="empModalTitle" class="text-xl font-bold text-gray-800">Add Employee Profile</h3>
                <button onclick="document.getElementById('modal-emp').classList.add('hidden')" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-red-100 hover:text-red-500 transition flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <form id="empForm" class="p-8 space-y-8">
                <input type="hidden" id="empId">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div><label class="text-xs font-bold text-gray-500">EMP CODE (Manual)</label><input id="empCode" required class="w-full mt-1 border rounded-lg p-2.5 bg-yellow-50 focus:ring-2 focus:ring-yellow-400 outline-none"></div>
                    <div><label class="text-xs font-bold text-gray-500">Full Name</label><input id="empName" required class="w-full mt-1 border rounded-lg p-2.5 focus:ring-2 focus:ring-theme-primary outline-none"></div>
                    <div><label class="text-xs font-bold text-gray-500">Department</label><select id="empDeptSelect" required class="w-full mt-1 border rounded-lg p-2.5 bg-white"></select></div>
                    <div><label class="text-xs font-bold text-gray-500">Designation</label><input id="empDesg" required class="w-full mt-1 border rounded-lg p-2.5"></div>
                    <div><label class="text-xs font-bold text-gray-500">DOJ</label><input type="date" id="empDOJ" required class="w-full mt-1 border rounded-lg p-2.5"></div>
                    <div><label class="text-xs font-bold text-gray-500">Status</label><select id="empStatus" class="w-full mt-1 border rounded-lg p-2.5"><option>FullTime</option><option>Contract</option></select></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 border-t pt-6">
                    <div><label class="text-xs font-bold text-gray-500">Bank Name</label><input id="empBank" class="w-full mt-1 border rounded-lg p-2.5"></div>
                    <div><label class="text-xs font-bold text-gray-500">Account No</label><input id="empAC" class="w-full mt-1 border rounded-lg p-2.5"></div>
                    <div><label class="text-xs font-bold text-gray-500">IFSC</label><input id="empIFSC" class="w-full mt-1 border rounded-lg p-2.5"></div>
                    <div><label class="text-xs font-bold text-gray-500">Aadhaar</label><input id="empAadhaar" class="w-full mt-1 border rounded-lg p-2.5"></div>
                    <div><label class="text-xs font-bold text-gray-500">UAN</label><input id="empUAN" class="w-full mt-1 border rounded-lg p-2.5"></div>
                    <div><label class="text-xs font-bold text-gray-500">ESI No</label><input id="empESI" class="w-full mt-1 border rounded-lg p-2.5"></div>
                </div>
                <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                    <h4 class="text-sm font-bold text-green-600 mb-4 uppercase">Monthly Salary Structure</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div><label class="text-xs font-bold text-gray-500">Basic</label><input type="number" id="salBasic" value="0" class="w-full mt-1 border rounded-lg p-2.5 font-mono"></div>
                        <div><label class="text-xs font-bold text-gray-500">DA</label><input type="number" id="salDA" value="0" class="w-full mt-1 border rounded-lg p-2.5 font-mono"></div>
                        <div><label class="text-xs font-bold text-gray-500">TA</label><input type="number" id="salTA" value="0" class="w-full mt-1 border rounded-lg p-2.5 font-mono"></div>
                        <div><label class="text-xs font-bold text-gray-500">HRA</label><input type="number" id="salHRA" value="0" class="w-full mt-1 border rounded-lg p-2.5 font-mono"></div>
                        <div><label class="text-xs font-bold text-gray-500">Other</label><input type="number" id="salOther" value="0" class="w-full mt-1 border rounded-lg p-2.5 font-mono"></div>
                        <div><label class="text-xs font-bold text-red-500">EPF</label><input type="number" id="salPF" value="0" class="w-full mt-1 border-red-200 bg-red-50 rounded-lg p-2.5 font-mono text-red-600"></div>
                        <div><label class="text-xs font-bold text-red-500">ESI</label><input type="number" id="salESIFix" value="0" class="w-full mt-1 border-red-200 bg-red-50 rounded-lg p-2.5 font-mono text-red-600"></div>
                    </div>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="document.getElementById('modal-emp').classList.add('hidden')" class="px-6 py-3 rounded-lg border font-bold hover:bg-gray-50 transition">Cancel</button>
                    <button class="px-8 py-3 bg-theme-primary text-white rounded-lg font-bold shadow hover:brightness-110 transition">Save Record</button>
                </div>
            </form>
        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script>
        // ================= CONFIGURATION =================
        // PASTE YOUR EXISTING GOOGLE SCRIPT URL HERE
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyA3Py_jTgXcZbNzHUINoaMUEAc_Qu-yXR6VhbwlBJN3hxwBRxg1OAVXOp9RBP1uaaa/exec";
        // =================================================

        let db = { depts: [], emps: [] };
        let currentUser = null;

        // --- UI UTILS ---
        function togglePass() { const i=document.getElementById('loginPass'); i.type = i.type==='password'?'text':'password'; }
        function toggleSidebar() { 
            const s=document.getElementById('sidebar'); 
            s.classList.toggle('w-64'); s.classList.toggle('w-0'); 
            s.classList.toggle('overflow-hidden');
        }
        function changeTheme(theme) {
            document.documentElement.className = theme;
            localStorage.setItem('hrms_theme', theme);
        }

        // --- API CORE ---
        async function callAPI(action, payload={}) {
            document.getElementById('loader').classList.remove('hidden');
            try {
                const res = await fetch(SCRIPT_URL, { method: "POST", headers: { "Content-Type": "text/plain;charset=utf-8" }, body: JSON.stringify({ action, ...payload }) });
                const data = await res.json();
                document.getElementById('loader').classList.add('hidden');
                return data;
            } catch(e) { document.getElementById('loader').classList.add('hidden'); alert("Server Connection Failed."); return {status:'error'}; }
        }

        // --- INIT ---
        window.onload = async () => {
            // Restore Theme
            const savedTheme = localStorage.getItem('hrms_theme') || 'default';
            document.documentElement.className = savedTheme;

            // Date Setup
            const ys = document.getElementById('psYear'); for(let y=2020; y<=2060; y++) { let o=document.createElement('option'); o.value=y; o.innerText=y; if(y==new Date().getFullYear()) o.selected=true; ys.appendChild(o); }

            // Load Data
            const res = await callAPI('GET_ALL_DATA');
            if(res.status === 'success') {
                db.depts = res.data.departments; db.emps = res.data.employees;
                document.getElementById('auth-wrapper').classList.remove('hidden'); // Show Auth BG
                if(!res.isSetup) document.getElementById('view-setup').classList.remove('hidden'); else document.getElementById('view-login').classList.remove('hidden');
            }
        };

        // --- NAVIGATION ---
        function navTo(id) {
            const permMap = {'tab-users':'manage_users', 'tab-depts':'manage_dept', 'tab-emp':'manage_emp', 'tab-pay':'generate_payslip', 'tab-history':'view_history'};
            if(currentUser.role !== 'SUPER_ADMIN' && permMap[id] && !currentUser.permissions[permMap[id]]) { alert("Access Denied"); return; }

            document.querySelectorAll('#view-dashboard main > div').forEach(e=>e.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(e => { e.classList.remove('bg-white/10','text-white','shadow-inner'); e.classList.add('text-slate-400'); });
            const active = document.getElementById('nav-'+id.split('-')[1]);
            active.classList.remove('text-slate-400'); active.classList.add('bg-white/10','text-white','shadow-inner');

            if(id=='tab-home') updateAIStats();
            if(id=='tab-emp') renderEmps();
            if(id=='tab-depts') renderDepts();
            if(id=='tab-pay') fillEmpSelect();
            if(id=='tab-history') loadHistory();
        }

        // --- AUTH ---
        document.getElementById('setupForm').onsubmit = async (e) => { e.preventDefault(); await callAPI('SETUP_ORG', { name:document.getElementById('setupOrg').value, address:document.getElementById('setupAddr').value, email:document.getElementById('setupEmail').value, password:document.getElementById('setupPass').value }); location.reload(); };
        document.getElementById('loginForm').onsubmit = async (e) => {
            e.preventDefault();
            const res = await callAPI('LOGIN', { email:document.getElementById('loginEmail').value, password:document.getElementById('loginPass').value });
            if(res.status === 'success') {
                currentUser = res.user;
                document.getElementById('userDisplay').innerText = currentUser.name;
                document.getElementById('roleDisplay').innerText = currentUser.role;
                document.querySelector('.sidebar-text').innerText = res.orgName;
                document.getElementById('auth-wrapper').classList.add('hidden');
                document.getElementById('view-dashboard').classList.remove('hidden');
                updateAIStats();
                if(currentUser.role!=='SUPER_ADMIN') document.getElementById('nav-users').classList.add('hidden');
            } else alert(res.msg);
        };

        // --- AI ANALYST ---
        function updateAIStats() {
            document.getElementById('statEmp').innerText = db.emps.length;
            document.getElementById('statDept').innerText = db.depts.length;
            
            // Simple Logic for AI Text
            if(db.emps.length > 0) {
                const totalSalary = db.emps.reduce((acc, e) => acc + (parseFloat(e.salary.basic)||0), 0);
                const avgSalary = Math.round(totalSalary / db.emps.length);
                const msg = `AI Insight: You have ${db.emps.length} employees across ${db.depts.length} departments. The average basic salary is ₹${avgSalary}. Workforce data is healthy.`;
                document.getElementById('aiInsightText').innerText = msg;
            } else {
                document.getElementById('aiInsightText').innerText = "AI Insight: No data available yet. Add employees to generate insights.";
            }
        }

        // --- CRUD OPERATIONS ---
        document.getElementById('deptForm').onsubmit = async (e) => { e.preventDefault(); const p={id:Date.now(), entity:document.getElementById('newEntity').value, name:document.getElementById('newDept').value, address:document.getElementById('newDeptAddr').value}; await callAPI('ADD_DEPT', p); db.depts.push(p); renderDepts(); e.target.reset(); };
        function renderDepts() { const tb=document.getElementById('deptTableBody'); tb.innerHTML=''; db.depts.forEach(d=>tb.innerHTML+=`<tr class="border-b"><td class="p-3 font-bold">${d.entity}</td><td class="p-3">${d.name}<br><span class="text-xs text-gray-400">${d.address||''}</span></td><td class="p-3 text-right"><button onclick="delDept(${d.id})" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i></button></td></tr>`); }
        async function delDept(id) { if(confirm('Delete?')) { await callAPI('DEL_DEPT', {id}); db.depts=db.depts.filter(d=>d.id!=id); renderDepts(); } }

        function openEmpModal(emp=null) {
            document.getElementById('modal-emp').classList.remove('hidden');
            const s=document.getElementById('empDeptSelect'); s.innerHTML=''; db.depts.forEach(d=>s.innerHTML+=`<option value="${d.id}">${d.entity} - ${d.name}</option>`);
            if(emp) {
                document.getElementById('empModalTitle').innerText='Edit Profile'; document.getElementById('empId').value=emp.id; document.getElementById('empCode').value=emp.code; document.getElementById('empName').value=emp.personal.name; document.getElementById('empDeptSelect').value=emp.deptId; document.getElementById('empDesg').value=emp.personal.desg; document.getElementById('empDOJ').value=emp.personal.doj.split('T')[0]; document.getElementById('empBank').value=emp.bank.name; document.getElementById('empAC').value=emp.bank.ac; document.getElementById('empIFSC').value=emp.bank.ifsc; document.getElementById('salBasic').value=emp.salary.basic; document.getElementById('salDA').value=emp.salary.da; document.getElementById('salPF').value=emp.salary.epf; 
            } else { document.getElementById('empForm').reset(); document.getElementById('empModalTitle').innerText='Add Employee'; document.getElementById('empId').value=''; }
        }

        document.getElementById('empForm').onsubmit = async (e) => {
            e.preventDefault(); const idVal=document.getElementById('empId').value;
            const emp = { id: idVal?idVal:Date.now(), deptId:document.getElementById('empDeptSelect').value, code:document.getElementById('empCode').value, personal: { name:document.getElementById('empName').value, desg:document.getElementById('empDesg').value, doj:document.getElementById('empDOJ').value, status:document.getElementById('empStatus').value, aadhaar:document.getElementById('empAadhaar').value, pan:document.getElementById('empPAN').value, uan:document.getElementById('empUAN').value }, bank: { name:document.getElementById('empBank').value, ac:document.getElementById('empAC').value, ifsc:document.getElementById('empIFSC').value, esi:document.getElementById('empESI').value }, salary: { basic:document.getElementById('salBasic').value, da:document.getElementById('salDA').value, ta:document.getElementById('salTA').value, hra:document.getElementById('salHRA').value, other:document.getElementById('salOther').value, epf:document.getElementById('salPF').value, esi_fixed:document.getElementById('salESIFix').value } };
            await callAPI('ADD_EMP', emp); if(idVal){const i=db.emps.findIndex(x=>x.id==idVal); if(i!==-1)db.emps[i]=emp;} else db.emps.push(emp);
            document.getElementById('modal-emp').classList.add('hidden'); renderEmps();
        };
        function renderEmps() { const tb=document.getElementById('empTableBody'); tb.innerHTML=''; db.emps.forEach(e=>{ const d=db.depts.find(x=>x.id==e.deptId)||{entity:'-',name:'-'}; tb.innerHTML+=`<tr class="border-b hover:bg-gray-50"><td class="p-4 font-mono text-blue-600 font-bold">${e.code}</td><td class="p-4 font-bold">${e.personal.name}<div class="text-xs text-gray-400 font-normal">${e.personal.desg}</div></td><td class="p-4 text-sm">${d.entity}<br>${d.name}</td><td class="p-4 text-right"><button onclick='openEmpModal(${JSON.stringify(e)})' class="text-blue-500 mr-3"><i class="fa-solid fa-pen"></i></button><button onclick="delEmp(${e.id})" class="text-red-500"><i class="fa-solid fa-trash"></i></button></td></tr>`; }); }
        async function delEmp(id) { if(confirm('Delete?')) { await callAPI('DEL_EMP', {id}); db.emps=db.emps.filter(e=>e.id!=id); renderEmps(); } }

        // --- PAYSLIP ---
        function fillEmpSelect() { const s=document.getElementById('psEmpSelect'); s.innerHTML='<option>-- Select --</option>'; db.emps.forEach(e=>s.innerHTML+=`<option value="${e.id}">${e.personal.name} (${e.code})</option>`); }
        function autoFetchEmp() { const id=document.getElementById('psEmpSelect').value; const e=db.emps.find(x=>x.id==id); if(e){ const d=db.depts.find(x=>x.id==e.deptId); document.getElementById('psDisplayInfo').value=`${e.personal.name} | ${e.personal.desg}`; document.getElementById('fixBasic').value=e.salary.basic; document.getElementById('fixDA').value=e.salary.da; document.getElementById('fixTA').value=e.salary.ta; document.getElementById('fixHRA').value=e.salary.hra; document.getElementById('fixOther').value=e.salary.other; document.getElementById('fixEPF').value=e.salary.epf; document.getElementById('fixESI').value=e.salary.esi_fixed; } }

        async function generatePDF() {
            const id = document.getElementById('psEmpSelect').value; if(!id || id.includes('Select')) return alert('Select Employee');
            const emp=db.emps.find(e=>e.id==id), dept=db.depts.find(d=>d.id==emp.deptId), m=document.getElementById('psMonth').value, y=document.getElementById('psYear').value;
            
            // Calc
            const basic=Number(document.getElementById('fixBasic').value), da=Number(document.getElementById('fixDA').value), ta=Number(document.getElementById('fixTA').value), hra=Number(document.getElementById('fixHRA').value), other=Number(document.getElementById('fixOther').value);
            const gross=basic+da+ta+hra+other;
            const epf=Number(document.getElementById('fixEPF').value), mut=Number(document.getElementById('psDedMUT').value), food=Number(document.getElementById('psDedFood').value), tax=Number(document.getElementById('psDedTax').value), esi=Number(document.getElementById('fixESI').value), welfare=Number(document.getElementById('psDedWelfare').value), adv=Number(document.getElementById('psDedAdv').value), lop=Number(document.getElementById('psDedLOP').value);
            const totalDed=epf+mut+food+tax+esi+welfare+adv+lop; const netPay=gross-totalDed;

            // PDF
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            doc.setFont("times", "bold"); doc.setFontSize(22); doc.text(dept.entity, 105, 15, null, null, "center");
            doc.setFont("times", "normal"); doc.setFontSize(10); doc.text(dept.address||"Head Office", 105, 20, null, null, "center");
            doc.setFont("times", "bold"); doc.setFontSize(14); doc.text(`Payslip: ${m}-${y}`, 105, 28, null, null, "center"); doc.line(10, 30, 200, 30);

            // Details
            let Y=40; doc.setFontSize(10); 
            doc.text(`Name: ${emp.personal.name}`, 15, Y); doc.text(`Desg: ${emp.personal.desg}`, 110, Y); Y+=6;
            doc.text(`Code: ${emp.code}`, 15, Y); doc.text(`Bank: ${emp.bank.name}`, 110, Y); Y+=6;
            doc.text(`UAN: ${emp.personal.uan}`, 15, Y); doc.text(`AC No: ${emp.bank.ac}`, 110, Y); Y+=10;

            // Table
            doc.autoTable({ startY: Y, head: [['Earnings', 'Amount', 'Deductions', 'Amount']], body: [['Basic', basic, 'EPF', epf], ['DA', da, 'Food', food], ['HRA', hra, 'Loan', adv], ['Other', other, 'LOP', lop], ['', '', 'Tax', tax]], theme: 'grid' });
            
            Y = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(12); doc.setFont("times", "bold");
            doc.text(`NET PAY: Rs. ${netPay}/-`, 195, Y, null, null, "right");
            
            doc.save(`Payslip_${emp.personal.name}.pdf`);
            await callAPI('SAVE_PAYSLIP', {month:m, year:y, empName:emp.personal.name, empCode:emp.code, netPay:netPay, user:currentUser.name});
        }

        async function loadHistory() {
            const res = await callAPI('GET_HISTORY');
            const tb = document.getElementById('historyTableBody'); tb.innerHTML = '';
            if(res.status=='success' && res.history) {
                res.history.forEach(h => {
                    tb.innerHTML += `<tr class="border-b"><td class="p-4 text-gray-500">${new Date(h[0]).toLocaleDateString()}</td><td class="p-4 font-bold">${h[1]}-${h[2]}</td><td class="p-4">${h[3]}<br><small class="text-gray-400">${h[4]}</small></td><td class="p-4 text-green-600 font-bold">₹${h[5]}</td><td class="p-4 text-right text-xs text-gray-400">${h[6]}</td></tr>`;
                });
            }
        }
    </script>
</body>
</html>