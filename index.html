<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise HRMS (RBAC)</title>
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { --primary: #0f172a; --accent: #2563eb; --bg: #f8fafc; --white: #fff; --text: #334155; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; color: var(--text); }
        .hidden { display: none !important; }
        
        /* Components */
        .btn { padding: 10px 18px; border: none; border-radius: 6px; cursor: pointer; background: var(--accent); color: white; font-weight: 600; }
        .btn:hover { background: #1d4ed8; } .btn-danger { background: #ef4444; } .btn-sm { padding: 5px 10px; font-size: 0.85rem; }
        .card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 5px; margin-top: 5px; box-sizing: border-box; }
        
        /* Auth & Layout */
        .auth-container { display: flex; justify-content: center; align-items: center; height: 100vh; }
        .auth-box { width: 400px; text-align: center; }
        .dashboard { display: flex; height: 100vh; }
        .sidebar { width: 260px; background: var(--primary); color: white; display: flex; flex-direction: column; }
        .brand { padding: 20px; font-size: 1.3rem; font-weight: bold; border-bottom: 1px solid #334155; }
        
        .nav-item { padding: 15px 20px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05); transition: 0.2s; display: flex; align-items: center; justify-content: space-between; }
        .nav-item:hover { background: rgba(255,255,255,0.1); }
        .nav-item.active { background: rgba(255,255,255,0.15); border-left: 4px solid var(--accent); }
        .nav-item.disabled { opacity: 0.5; cursor: not-allowed; } /* Visual cue for no permission */
        
        .content { flex: 1; padding: 30px; overflow-y: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        /* Loader */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction: column; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Tables */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; border-radius: 8px; overflow: hidden; }
        th { background: #e2e8f0; padding: 12px; text-align: left; }
        td { padding: 10px 12px; border-bottom: 1px solid #f1f5f9; }
    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div><p style="margin-top:10px">Connecting to Cloud...</p></div>

    <!-- 1. SETUP (Only for First Time) -->
    <div id="view-setup" class="auth-container hidden">
        <div class="card auth-box">
            <h2 style="color:var(--primary)">Initial Setup</h2>
            <p>Create Super Admin Account</p>
            <form id="setupForm">
                <input id="setupOrg" placeholder="Organization Name" required>
                <input id="setupAddr" placeholder="Address" required>
                <input type="email" id="setupEmail" placeholder="Admin Email" required>
                <input type="password" id="setupPass" placeholder="Create Password" required>
                <button class="btn" style="width:100%; margin-top:15px">Initialize System</button>
            </form>
        </div>
    </div>

    <!-- 2. LOGIN -->
    <div id="view-login" class="auth-container hidden">
        <div class="card auth-box">
            <h2 style="color:var(--primary)" id="loginOrgName">HRMS Login</h2>
            <form id="loginForm">
                <input type="email" id="loginEmail" placeholder="Email ID" required>
                <input type="password" id="loginPass" placeholder="Password" required>
                <button class="btn" style="width:100%; margin-top:15px">Sign In</button>
            </form>
        </div>
    </div>

    <!-- 3. DASHBOARD -->
    <div id="view-dashboard" class="dashboard hidden">
        <div class="sidebar">
            <div class="brand">Admin Console</div>
            
            <!-- Navigation Items (IDs are important for Permissions) -->
            <div class="nav-item active" id="nav-home" onclick="navTo('tab-home', 'view_dashboard')">
                <span>üìä Dashboard</span>
            </div>
            <div class="nav-item" id="nav-users" onclick="navTo('tab-users', 'manage_users')">
                <span>üîê Admin Console</span> <span style="font-size:0.7rem">SUPER ONLY</span>
            </div>
            <div class="nav-item" id="nav-depts" onclick="navTo('tab-depts', 'manage_dept')">
                <span>üè¢ Departments</span>
            </div>
            <div class="nav-item" id="nav-emp" onclick="navTo('tab-emp', 'manage_emp')">
                <span>üë• Employees</span>
            </div>
            <div class="nav-item" id="nav-pay" onclick="navTo('tab-pay', 'generate_payslip')">
                <span>üßæ Payslip</span>
            </div>
            
            <div style="flex:1"></div>
            <div class="nav-item" onclick="location.reload()" style="background: #ef4444;">üö™ Logout</div>
        </div>

        <div class="content">
            <div class="header">
                <h2 id="pageTitle">Overview</h2>
                <div>
                    <span id="userDisplay" style="font-weight:bold; color:var(--accent)">User</span>
                    <span id="roleDisplay" style="background:#e2e8f0; padding:2px 8px; border-radius:4px; font-size:0.8rem; margin-left:5px">Role</span>
                </div>
            </div>

            <!-- HOME -->
            <div id="tab-home">
                <div class="grid-3">
                    <div class="card"><h3>Total Employees</h3><h1 id="statEmp">0</h1></div>
                    <div class="card"><h3>Departments</h3><h1 id="statDept">0</h1></div>
                    <div class="card"><h3>System Status</h3><p style="color:green">Active & Connected</p></div>
                </div>
            </div>

            <!-- ADMIN CONSOLE (USER MANAGEMENT) -->
            <div id="tab-users" class="hidden">
                <div class="grid-2">
                    <div class="card">
                        <h3>Create System User</h3>
                        <form id="userForm">
                            <input id="newUserName" placeholder="Full Name" required>
                            <input type="email" id="newUserEmail" placeholder="Email" required>
                            <input type="password" id="newUserPass" placeholder="Password" required>
                            <select id="newUserRole">
                                <option value="HR">HR Manager</option>
                                <option value="MANAGER">Dept Manager</option>
                                <option value="ACCOUNTANT">Accountant</option>
                            </select>
                            
                            <p style="margin-top:15px; font-weight:bold; font-size:0.9rem">Permissions:</p>
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; font-size:0.9rem">
                                <div><input type="checkbox" id="perm_dash" checked> View Dashboard</div>
                                <div><input type="checkbox" id="perm_dept"> Manage Depts</div>
                                <div><input type="checkbox" id="perm_emp"> Manage Staff</div>
                                <div><input type="checkbox" id="perm_pay"> Generate Payslip</div>
                                <!-- Only Super Admin can manage users, not selectable -->
                            </div>

                            <button class="btn" style="width:100%; margin-top:15px">Create User</button>
                        </form>
                    </div>
                    <div class="card">
                        <h3>System Users</h3>
                        <table id="userTable">
                            <thead><tr><th>Name</th><th>Role</th><th>Action</th></tr></thead>
                            <tbody id="userTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- DEPARTMENTS -->
            <div id="tab-depts" class="hidden">
                <div class="grid-2">
                    <div class="card">
                        <form id="deptForm">
                            <input id="newEntity" placeholder="Entity Name" required>
                            <input id="newDept" placeholder="Dept Name" required>
                            <button class="btn" style="margin-top:10px">Add Dept</button>
                        </form>
                    </div>
                    <div class="card">
                        <table id="deptTable"><thead><tr><th>Entity</th><th>Dept</th><th>Act</th></tr></thead><tbody id="deptTableBody"></tbody></table>
                    </div>
                </div>
            </div>

            <!-- EMPLOYEES -->
            <div id="tab-emp" class="hidden">
                <div style="margin-bottom:15px"><button class="btn" onclick="toggleModal('modal-emp')">+ Add Employee</button></div>
                <div class="card">
                    <table id="empTable"><thead><tr><th>Code</th><th>Name</th><th>Dept</th><th>Action</th></tr></thead><tbody id="empTableBody"></tbody></table>
                </div>
            </div>

            <!-- PAYSLIP -->
            <div id="tab-pay" class="hidden">
                <div class="card" style="max-width:800px">
                    <select id="psEmpSelect" onchange="autoFetchEmp()"><option>Select Employee</option></select>
                    <p id="psInfo" style="color:var(--accent); font-weight:bold; margin:10px 0"></p>
                    <div class="grid-3">
                        <select id="psMonth"><option>January</option><option>February</option><option>March</option><option>April</option><option>May</option><option>June</option><option>July</option><option>August</option><option>September</option><option>October</option><option>November</option><option>December</option></select>
                        <select id="psYear"></select>
                        <input type="number" id="psDays" value="30" placeholder="Total Days">
                    </div>
                    <div class="grid-2">
                         <input type="number" id="psDedFood" placeholder="Food Deduction">
                         <input type="number" id="psDedAdv" placeholder="Advance Deduction">
                    </div>
                    <input type="hidden" id="fixBasic"><input type="hidden" id="fixDA"><input type="hidden" id="fixHRA"><input type="hidden" id="fixOther"><input type="hidden" id="fixPF">
                    <button class="btn" style="width:100%; margin-top:20px" onclick="generatePDF()">Generate Payslip</button>
                </div>
            </div>

        </div>
    </div>

    <!-- Modal for Employee -->
    <div id="modal-emp" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center">
        <div class="card" style="width:700px; max-height:90vh; overflow-y:auto">
            <h3>Add Employee <button onclick="toggleModal('modal-emp')" style="float:right; border:none; background:none; font-size:1.2rem; cursor:pointer">X</button></h3>
            <form id="empForm">
                <div class="grid-2">
                    <input id="empName" placeholder="Name" required>
                    <select id="empDeptSelect" required></select>
                    <input id="empDesg" placeholder="Designation" required>
                    <input type="date" id="empDOJ" required>
                    <input id="empAadhaar" placeholder="Aadhaar">
                    <input id="empPAN" placeholder="PAN">
                    <input id="empBank" placeholder="Bank Name">
                    <input id="empAC" placeholder="Account No">
                    <input id="empIFSC" placeholder="IFSC">
                    <input id="empESI" placeholder="ESI No">
                </div>
                <h4>Salary</h4>
                <div class="grid-3">
                    <input type="number" id="salBasic" placeholder="Basic" value="0">
                    <input type="number" id="salDA" placeholder="DA" value="0">
                    <input type="number" id="salHRA" placeholder="HRA" value="0">
                    <input type="number" id="salOther" placeholder="Others" value="0">
                    <input type="number" id="salPF" placeholder="PF" value="0">
                </div>
                <button class="btn" style="margin-top:20px; width:100%">Save Employee</button>
            </form>
        </div>
    </div>

    <script>
        // -----------------------------------------------------------
        // CONFIGURATION (YOUR NEW URL)
        // -----------------------------------------------------------
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbynR24i1LHj-fB_w51pdJ0OHGOQstq1xZbPBR4FkcVb1y5L7GXfAmKybQinrMK43Jin/exec";
        
        // State
        let db = { depts: [], emps: [] };
        let currentUser = null; // Stores {role, permissions}

        // --- CORE FUNCTIONS (FIXED FOR CORS) ---
        async function callAPI(action, payload={}) {
            document.getElementById('loader').classList.remove('hidden');
            try {
                // FIXED: Using text/plain ensures simple POST request, bypassing strict CORS preflight
                const res = await fetch(SCRIPT_URL, { 
                    method: "POST", 
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify({ action, ...payload }) 
                });
                
                const data = await res.json();
                document.getElementById('loader').classList.add('hidden');
                return data;
            } catch(e) { 
                document.getElementById('loader').classList.add('hidden');
                console.error(e);
                // Usually means CORS block or Script Error
                alert("Connection Failed! Please check if your Google Script is deployed as 'Anyone'."); 
                return {status:'error'}; 
            }
        }

        // --- INIT ---
        window.onload = async () => {
            // Fill Years
            const ys = document.getElementById('psYear');
            for(let y=2020; y<=2060; y++) { let o=document.createElement('option'); o.value=y; o.innerText=y; if(y==new Date().getFullYear()) o.selected=true; ys.appendChild(o); }

            // Check if System is Setup
            const res = await callAPI('GET_ALL_DATA');
            if(res.status === 'success') {
                db.depts = res.data.departments || [];
                db.emps = res.data.employees || [];
                
                if(!res.isSetup) {
                    showView('view-setup');
                } else {
                    showView('view-login');
                }
            }
        };

        // --- NAVIGATION & PERMISSIONS ---
        function showView(id) {
            document.querySelectorAll('.auth-container, .dashboard').forEach(e => e.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        function navTo(tabId, requiredPerm) {
            // Permission Check
            if(currentUser.role !== 'SUPER_ADMIN') {
                if(!currentUser.permissions[requiredPerm]) {
                    alert("‚ö†Ô∏è Access Denied: You do not have permission to access this module.");
                    return; // Stop here, don't switch tab
                }
            }

            // Switch Tab
            document.querySelectorAll('[id^="tab-"]').forEach(e => e.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            
            // Highlight sidebar
            let navId = '';
            if(tabId=='tab-home') navId='nav-home';
            if(tabId=='tab-users') navId='nav-users';
            if(tabId=='tab-depts') navId='nav-depts';
            if(tabId=='tab-emp') navId='nav-emp';
            if(tabId=='tab-pay') navId='nav-pay';
            if(navId) document.getElementById(navId).classList.add('active');

            // Refresh Data if needed
            if(tabId === 'tab-users') loadSystemUsers();
            if(tabId === 'tab-depts') renderDepts();
            if(tabId === 'tab-emp') renderEmps();
            if(tabId === 'tab-pay') fillEmpSelect();
        }

        function applyVisualPermissions() {
            // Dims buttons if no access (but keeps them visible)
            const map = {
                'nav-users': 'manage_users',
                'nav-depts': 'manage_dept',
                'nav-emp': 'manage_emp',
                'nav-pay': 'generate_payslip'
            };

            for(const [navId, perm] of Object.entries(map)) {
                const el = document.getElementById(navId);
                if(currentUser.role !== 'SUPER_ADMIN' && !currentUser.permissions[perm]) {
                    el.classList.add('disabled'); // Make it look gray
                    el.title = "Access Denied";
                } else {
                    el.classList.remove('disabled');
                }
            }
        }

        // --- SETUP ---
        document.getElementById('setupForm').onsubmit = async (e) => {
            e.preventDefault();
            const payload = {
                name: document.getElementById('setupOrg').value,
                address: document.getElementById('setupAddr').value,
                email: document.getElementById('setupEmail').value,
                password: document.getElementById('setupPass').value
            };
            const res = await callAPI('SETUP_ORG', payload);
            if(res.status === 'success') location.reload();
        };

        // --- LOGIN ---
        document.getElementById('loginForm').onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;
            
            const res = await callAPI('LOGIN', { email: email, password: pass });
            if(res.status === 'success') {
                currentUser = res.user;
                document.getElementById('userDisplay').innerText = currentUser.name;
                document.getElementById('roleDisplay').innerText = currentUser.role;
                document.getElementById('pageTitle').innerText = res.orgName;
                
                showView('view-dashboard');
                applyVisualPermissions();
                
                // Update stats
                document.getElementById('statEmp').innerText = db.emps.length;
                document.getElementById('statDept').innerText = db.depts.length;
            } else {
                alert(res.msg);
            }
        };

        // --- ADMIN CONSOLE (USER MGMT) ---
        document.getElementById('userForm').onsubmit = async (e) => {
            e.preventDefault();
            const payload = {
                name: document.getElementById('newUserName').value,
                email: document.getElementById('newUserEmail').value,
                password: document.getElementById('newUserPass').value,
                role: document.getElementById('newUserRole').value,
                permissions: {
                    view_dashboard: document.getElementById('perm_dash').checked,
                    manage_dept: document.getElementById('perm_dept').checked,
                    manage_emp: document.getElementById('perm_emp').checked,
                    generate_payslip: document.getElementById('perm_pay').checked,
                    manage_users: false // Only Super Admin
                }
            };
            await callAPI('ADD_SYS_USER', payload);
            alert("User Created!");
            loadSystemUsers();
            e.target.reset();
        };

        async function loadSystemUsers() {
            const res = await callAPI('GET_SYS_USERS');
            const tb = document.getElementById('userTableBody'); tb.innerHTML = '';
            res.users.forEach(u => {
                tb.innerHTML += `<tr><td>${u.name}<br><small>${u.email}</small></td><td>${u.role}</td>
                <td>${u.role !== 'SUPER_ADMIN' ? `<button class="btn btn-danger btn-sm" onclick="delUser('${u.email}')">X</button>` : '-'}</td></tr>`;
            });
        }
        async function delUser(email) {
            if(confirm("Delete this user?")) {
                await callAPI('DEL_SYS_USER', {email});
                loadSystemUsers();
            }
        }

        // --- DEPARTMENTS ---
        document.getElementById('deptForm').onsubmit = async (e) => {
            e.preventDefault();
            const p = { id:Date.now(), entity:document.getElementById('newEntity').value, name:document.getElementById('newDept').value };
            await callAPI('ADD_DEPT', p);
            db.depts.push(p); renderDepts(); e.target.reset();
        };
        function renderDepts() {
            const tb = document.getElementById('deptTableBody'); tb.innerHTML='';
            db.depts.forEach(d => tb.innerHTML += `<tr><td>${d.entity}</td><td>${d.name}</td><td><button class="btn btn-danger btn-sm" onclick="delDept(${d.id})">X</button></td></tr>`);
        }
        async function delDept(id) { if(confirm('Delete?')) { await callAPI('DEL_DEPT', {id}); db.depts=db.depts.filter(d=>d.id!==id); renderDepts(); } }

        // --- EMPLOYEES ---
        function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); fillDeptSelect(); }
        function fillDeptSelect() {
            const s = document.getElementById('empDeptSelect'); s.innerHTML='';
            db.depts.forEach(d => s.innerHTML += `<option value="${d.id}">${d.entity} - ${d.name}</option>`);
        }
        document.getElementById('empForm').onsubmit = async (e) => {
            e.preventDefault();
            const emp = {
                id:Date.now(), deptId:document.getElementById('empDeptSelect').value, code:'EMP'+Math.floor(Math.random()*9000),
                personal: { name:document.getElementById('empName').value, desg:document.getElementById('empDesg').value, doj:document.getElementById('empDOJ').value, status:'Active', aadhaar:document.getElementById('empAadhaar').value, pan:document.getElementById('empPAN').value, uan:'' },
                bank: { name:document.getElementById('empBank').value, ac:document.getElementById('empAC').value, ifsc:document.getElementById('empIFSC').value, esi:document.getElementById('empESI').value, mut:'' },
                salary: { basic:document.getElementById('salBasic').value, da:document.getElementById('salDA').value, hra:document.getElementById('salHRA').value, ta:0, other:document.getElementById('salOther').value, epf:document.getElementById('salPF').value }
            };
            await callAPI('ADD_EMP', emp); db.emps.push(emp); toggleModal('modal-emp'); renderEmps();
        };
        function renderEmps() {
            const tb = document.getElementById('empTableBody'); tb.innerHTML='';
            db.emps.forEach(e => {
                const d = db.depts.find(dp=>dp.id==e.deptId)||{name:'-'};
                tb.innerHTML += `<tr><td>${e.code}</td><td>${e.personal.name}</td><td>${d.name}</td><td><button class="btn btn-danger btn-sm" onclick="delEmp(${e.id})">X</button></td></tr>`;
            });
        }
        async function delEmp(id) { if(confirm('Delete?')) { await callAPI('DEL_EMP', {id}); db.emps=db.emps.filter(e=>e.id!==id); renderEmps(); } }

        // --- PAYSLIP ---
        function fillEmpSelect() {
            const s = document.getElementById('psEmpSelect'); s.innerHTML='<option>Select Employee</option>';
            db.emps.forEach(e => s.innerHTML+=`<option value="${e.id}">${e.personal.name}</option>`);
        }
        function autoFetchEmp() {
            const id = document.getElementById('psEmpSelect').value;
            const emp = db.emps.find(e=>e.id==id);
            if(emp) {
                document.getElementById('psInfo').innerText = `Selected: ${emp.personal.name} (${emp.personal.desg})`;
                document.getElementById('fixBasic').value = emp.salary.basic;
                document.getElementById('fixDA').value = emp.salary.da;
                document.getElementById('fixHRA').value = emp.salary.hra;
                document.getElementById('fixOther').value = emp.salary.other;
                document.getElementById('fixPF').value = emp.salary.epf;
            }
        }
        async function generatePDF() {
            const id = document.getElementById('psEmpSelect').value;
            if(!id) return alert('Select Employee');
            // Basic Calc for PDF demo
            const emp = db.emps.find(e=>e.id==id);
            const dept = db.depts.find(d=>d.id==emp.deptId);
            const net = (parseFloat(emp.salary.basic)+parseFloat(emp.salary.da)) - parseFloat(emp.salary.epf); // Simple logic
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Header
            doc.setFontSize(18); doc.setFont("helvetica", "bold");
            doc.text(dept.entity.toUpperCase(), 105, 15, null, null, "center");
            doc.setFontSize(10); doc.setFont("helvetica", "normal");
            doc.line(10, 25, 200, 25);
            doc.text("PAYSLIP", 105, 35, null, null, "center");

            doc.autoTable({
                startY: 40,
                body: [
                    ['Name', emp.personal.name, 'Designation', emp.personal.desg],
                    ['Department', dept.name, 'Net Pay', net.toFixed(2)]
                ]
            });
            
            doc.save(`Payslip_${emp.personal.name}.pdf`);
            
            await callAPI('SAVE_PAYSLIP', {month:document.getElementById('psMonth').value, year:document.getElementById('psYear').value, empName:emp.personal.name, empCode:emp.code, department:dept.name, entity:dept.entity, netPay:net});
            alert('Payslip Saved');
        }

    </script>
</body>
</html>
